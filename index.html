<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>L·ªãch √Çm D∆∞∆°ng (Google Login)</title>

  <style>
    :root{
        --bg: #f1f5f9; --card: #ffffff; --text: #334155; --muted: #94a3b8;
        --accent: #2563eb; --border: #e2e8f0; --danger: #ef4444;
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin:0; background:var(--bg); color:var(--text); min-height:100vh; display:flex; justify-content:center; padding:20px}
    .app{width:100%; max-width:800px}
    
    /* Header & Logo */
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px}
    .header-left{display:flex; gap:12px; align-items:center}
    .logo-img{width:50px; height:50px; object-fit:cover; border-radius:50%; border:2px solid var(--accent); box-shadow:0 2px 5px rgba(0,0,0,0.1)}
    
    h1{font-size:22px;margin:0;font-weight:700;color:#1e293b}
    .auth-pill{display:flex;gap:8px;align-items:center}
    
    /* Buttons */
    button{background:var(--accent);border:none;padding:8px 16px;border-radius:8px;color:#fff;cursor:pointer;font-weight:600;font-size:14px;transition:0.2s; box-shadow: 0 2px 4px rgba(37,99,235,0.2)}
    button:hover{filter:brightness(1.1)}
    .ghost{background:white; border:1px solid var(--border); color:var(--text); box-shadow:none}
    .ghost:hover{background:var(--bg)}
    .danger{background:white; color:var(--danger); border:1px solid #fecaca; box-shadow:none}
    .btn-icon{padding:8px 10px}

    /* Google Button */
    .btn-google{
        background:white; color:#333; border:1px solid #ddd; width:100%; 
        display:flex; align-items:center; justify-content:center; gap:10px; padding:12px;
        font-size:15px; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.05);
    }
    .btn-google:hover{background:#f8f9fa; border-color:#ccc}
    .google-icon{width:20px; height:20px}

    /* Calendar & UI Elements (Gi·ªØ nguy√™n) */
    .calendar-ctrl{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .calendar-title{font-size:18px;font-weight:700;color:var(--accent)}
    .grid-header{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:8px;text-align:center;font-weight:600;color:var(--muted);font-size:13px}
    .grid-days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day-cell{background:var(--card);border:1px solid var(--border);border-radius:10px;min-height:85px;padding:6px;cursor:pointer;display:flex;flex-direction:column;justify-content:space-between;position:relative}
    .day-cell.today{border:2px solid var(--accent);background:white}
    .day-cell.active{background:var(--accent);color:white;border-color:var(--accent)}
    .day-cell.active .lunar-info{color:rgba(255,255,255,0.8)}
    .solar-num{font-size:18px;font-weight:700}
    .lunar-info{font-size:12px;color:var(--muted);text-align:right}
    .lunar-info.special{color:#e11d48;font-weight:600}
    .has-note-dot{width:6px;height:6px;background:#f59e0b;border-radius:50%;position:absolute;top:6px;right:6px}
    .controls-bar{display:flex;gap:10px;margin-top:16px;background:var(--card);padding:12px;border-radius:12px;border:1px solid var(--border)}
    .controls-bar button{flex:1}
    .card{background:var(--card);border-radius:16px;padding:20px;margin-bottom:16px;border:1px solid var(--border)}
    input,textarea{background:#f8fafc;border:1px solid var(--border);padding:12px;border-radius:8px;color:var(--text);width:100%;outline:none;font-family:inherit}
    input:focus,textarea:focus{border-color:var(--accent);background:#fff}
    .row{display:flex;gap:10px;align-items:center}
    .tabs{display:flex;gap:8px;margin-bottom:16px;background:#f1f5f9;padding:4px;border-radius:10px;width:fit-content}
    .tab{padding:6px 16px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;color:var(--muted)}
    .tab.active{background:white;color:var(--accent);box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    
    /* Modals */
    .modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,0.5);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:999;padding:15px}
    .modal{background:white;width:100%;max-width:400px;border-radius:16px;padding:24px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);animation:popUp 0.2s ease-out}
    .modal h3{margin:0 0 15px 0;font-size:20px;color:var(--text);text-align:center}
    .modal-body{display:flex;flex-direction:column;gap:12px}
    .list-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border)}
    .list-item:last-child{border-bottom:none}
    .list-date{font-weight:700;font-size:14px;color:var(--accent)}
    
    @keyframes popUp{from{transform:scale(0.95);opacity:0}to{transform:scale(1);opacity:1}}
    @media (max-width:600px){.controls-bar{flex-direction:column}}
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="header-left">
        <img src="logo.png" alt="Logo" class="logo-img" onerror="this.style.display='none'">
        <div>
          <h1>L·ªãch √Çm D∆∞∆°ng</h1>
          <div style="font-size:13px;color:var(--muted)">CAO HO√ÄI S∆†N ‚Ä¢ Light Mode</div>
        </div>
      </div>
      <div class="auth-pill">
        <span id="authState" style="font-size:12px;color:var(--muted);display:none"></span>
        <button id="btnAuth" class="ghost" style="font-size:12px">Login</button>
      </div>
    </header>

    <section class="card" style="padding:15px">
        <div class="calendar-ctrl">
            <button id="prevMonth" class="ghost btn-icon">&lt;</button>
            <div class="calendar-title" id="calTitle">...</div>
            <button id="nextMonth" class="ghost btn-icon">&gt;</button>
        </div>
        <div class="grid-header"><div>CN</div><div>T2</div><div>T3</div><div>T4</div><div>T5</div><div>T6</div><div>T7</div></div>
        <div class="grid-days" id="calendarGrid"></div>
        <div class="controls-bar">
             <button id="btnAddNote" style="background:var(--accent)">+ Th√™m ghi ch√∫</button>
             <button id="btnViewAllNotes" class="ghost">üìã Xem danh s√°ch</button>
             <button id="btnJumpToday" class="ghost">V·ªÅ h√¥m nay</button>
        </div>
    </section>

    <section class="card">
        <div class="tabs">
            <div class="tab active" data-tab="s2l">D∆∞∆°ng ‚Üí √Çm</div>
            <div class="tab" data-tab="l2s">√Çm ‚Üí D∆∞∆°ng</div>
        </div>
        <div id="tabS2L">
            <div class="row">
                <input type="text" id="solarInput" class="date-mask" placeholder="dd/mm/yyyy" inputmode="numeric">
                <button id="toLunar" style="width:100px">Tra c·ª©u</button>
            </div>
            <div id="s2lResult" style="margin-top:12px;font-weight:600;color:var(--accent)"></div>
        </div>
        <div id="tabL2S" style="display:none">
            <div class="row">
                <input type="text" id="lunarInput" class="date-mask" placeholder="dd/mm/yyyy (√¢m)" inputmode="numeric">
                <label style="white-space:nowrap;font-size:13px;display:flex;align-items:center;gap:4px">
                    <input type="checkbox" id="isLeap" style="width:auto"> Nhu·∫≠n
                </label>
                <button id="toSolar" style="width:100px">Tra c·ª©u</button>
            </div>
            <div id="l2sResult" style="margin-top:12px;font-weight:600;color:var(--accent)"></div>
        </div>
    </section>
  </div>

  <div id="loginModal" class="modal-overlay">
    <div class="modal">
        <h3>ƒêƒÉng nh·∫≠p</h3>
        <div class="modal-body" style="text-align:center">
            <p style="color:var(--muted);font-size:14px;margin:0 0 10px 0">
                ƒêƒÉng nh·∫≠p ƒë·ªÉ ƒë·ªìng b·ªô ghi ch√∫ tr√™n m·ªçi thi·∫øt b·ªã.
            </p>
            <button id="btnGoogleLogin" class="btn-google">
                <svg class="google-icon" viewBox="0 0 48 48">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
                </svg>
                Ti·∫øp t·ª•c v·ªõi Google
            </button>
            <div style="margin-top:15px;font-size:13px;color:var(--muted);cursor:pointer" onclick="closeModals()">ƒê√≥ng</div>
        </div>
    </div>
  </div>

  <div id="noteModal" class="modal-overlay">
      <div class="modal">
          <h3>‚úçÔ∏è Vi·∫øt ghi ch√∫</h3>
          <div class="modal-body">
              <div class="row">
                  <div style="flex:1"><label style="font-size:12px;font-weight:600">Ng√†y √Çm</label><input type="text" id="popupDay" class="date-mask-short" placeholder="dd/mm"></div>
                  <div style="flex:1"><label style="font-size:12px;font-weight:600">NƒÉm (Tu·ª≥ ch·ªçn)</label><input type="number" id="popupYear" placeholder="yyyy"></div>
              </div>
              <label style="display:flex;gap:8px;align-items:center;font-size:14px"><input type="checkbox" id="popupAnnual" style="width:auto"> L·∫∑p l·∫°i h√†ng nƒÉm</label>
              <textarea id="popupText" rows="4" placeholder="N·ªôi dung ghi ch√∫..."></textarea>
              <div class="row" style="margin-top:10px">
                  <button id="btnSaveNote" style="flex:1">L∆∞u</button>
                  <button onclick="closeModals()" class="ghost">Hu·ª∑</button>
              </div>
          </div>
      </div>
  </div>

  <div id="listModal" class="modal-overlay">
      <div class="modal" style="max-height:80vh;display:flex;flex-direction:column">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
              <h3>Danh s√°ch ghi ch√∫</h3>
              <button onclick="closeModals()" class="ghost" style="padding:4px 8px">‚úï</button>
          </div>
          <div style="overflow-y:auto;flex:1;border-top:1px solid var(--border);border-bottom:1px solid var(--border)" id="notesListContainer"></div>
          <div style="margin-top:15px;text-align:center"><button id="btnOpenAddFromList" class="ghost" style="width:100%">+ Th√™m th·ªß c√¥ng</button></div>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } 
        from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot } 
        from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';

    // --- CONFIG FIREBASE C·ª¶A M√ÄY ---
    const firebaseConfig = {
      apiKey: "AIzaSyDtBHNripkXGG__LgW16VO0bKCayxzVarE",
      authDomain: "ghichulich.firebaseapp.com",
      projectId: "ghichulich",
      storageBucket: "ghichulich.firebasestorage.app",
      messagingSenderId: "102308589212",
      appId: "1:102308589212:web:f4ce4981e3a6214eeb0759"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    // STATE
    let currentUser = null;
    let notesMap = new Map();
    let viewMonth = new Date().getMonth(), viewYear = new Date().getFullYear(), selectedDate = new Date(); 

    // HELPERS (Gi·ªØ nguy√™n)
    function pad(n){return n.toString().padStart(2,'0')}
    function jdFromDate(dd,mm,yy){var a=Math.floor((14-mm)/12);var y=yy+4800-a;var m=mm+12*a-3;var jd=dd+Math.floor((153*m+2)/5)+365*y+Math.floor(y/4)-Math.floor(y/100)+Math.floor(y/400)-32045;if(jd<2299161)jd=dd+Math.floor((153*m+2)/5)+365*y+Math.floor(y/4)-32083;return jd}
    function jdToDate(jd){var a,b,c,d,e,m;if(jd>2299160){a=jd+32044;b=Math.floor((4*a+3)/146097);c=a-Math.floor((b*146097)/4)}else{b=0;c=jd+32082}d=Math.floor((4*c+3)/1461);e=c-Math.floor((1461*d)/4);m=Math.floor((5*e+2)/153);var day=e-Math.floor((153*m+2)/5)+1;var month=m+3-12*Math.floor(m/10);var year=b*100+d-4800+Math.floor(m/10);return[day,month,year]}
    function getNewMoonDay(k,timeZone){var T=k/1236.85,T2=T*T,T3=T2*T,dr=Math.PI/180;var Jd1=2415020.75933+29.53058868*k+0.0001178*T2-0.000000155*T3;Jd1+=0.00033*Math.sin((166.56+132.87*T-0.009173*T2)*dr);var M=359.2242+29.10535608*k-0.0000333*T2-0.00000347*T3;var Mpr=306.0253+385.81691806*k+0.0107306*T2+0.00001236*T3;var F=21.2964+390.67050646*k-0.0016528*T2-0.00000239*T3;var C1=(0.1734-0.000393*T)*Math.sin(M*dr)+0.0021*Math.sin(2*dr*M);C1=C1-0.4068*Math.sin(Mpr*dr)+0.0161*Math.sin(2*dr*Mpr)-0.0004*Math.sin(3*dr*Mpr);C1=C1+0.0104*Math.sin(2*dr*F)-0.0051*Math.sin((M+Mpr)*dr)-0.0074*Math.sin((M-Mpr)*dr);C1=C1+0.0004*Math.sin((2*F+M)*dr)-0.0004*Math.sin((2*F-M)*dr)-0.0006*Math.sin((2*F+Mpr)*dr);C1=C1+0.0010*Math.sin((2*F-Mpr)*dr)+0.0005*Math.sin((2*Mpr)*dr);var deltaT;if(T<-11)deltaT=0.001+0.000839*T+0.0002261*T2-0.00000845*T3-0.000000081*T*T3;else deltaT=-0.000278+0.000265*T+0.000262*T2;var JdNew=Jd1+C1-deltaT;return Math.floor(JdNew+0.5+timeZone/24)}
    function getSunLongitude(jdn,timeZone){var T=(jdn-2451545.5-timeZone/24)/36525,T2=T*T,dr=Math.PI/180;var M=357.52910+35999.05030*T-0.0001559*T2-0.00000048*T*T2;var L0=280.46645+36000.76983*T+0.0003032*T2;var DL=(1.914600-0.004817*T-0.000014*T2)*Math.sin(dr*M);DL=DL+(0.019993-0.000101*T)*Math.sin(dr*2*M)+0.000290*Math.sin(dr*3*M);var L=(L0+DL)*dr;L=L-Math.PI*2*(Math.floor(L/(Math.PI*2)));return Math.floor(L/Math.PI*6)}
    function getLunarMonth11(yy,timeZone){var off=jdFromDate(31,12,yy)-2415021;var k=Math.floor(off/29.530588853);var nm=getNewMoonDay(k,timeZone);if(getSunLongitude(nm,timeZone)>=9)nm=getNewMoonDay(k-1,timeZone);return nm}
    function getLeapMonthOffset(a11,timeZone){var k=Math.floor((a11-2415021.076998695)/29.530588853+0.5);var last=0,i=1;var arc=getSunLongitude(getNewMoonDay(k+i,timeZone),timeZone);do{last=arc;i++;arc=getSunLongitude(getNewMoonDay(k+i,timeZone),timeZone)}while(arc!==last&&i<14);return i-1}
    function convertSolar2Lunar(dd,mm,yy,timeZone){var dayNumber=jdFromDate(dd,mm,yy);var k=Math.floor((dayNumber-2415021.076998695)/29.530588853);var monthStart=getNewMoonDay(k+1,timeZone);if(monthStart>dayNumber)monthStart=getNewMoonDay(k,timeZone);var a11=getLunarMonth11(yy,timeZone),b11=a11,lunarYear;if(a11>=monthStart){lunarYear=yy;a11=getLunarMonth11(yy-1,timeZone)}else{lunarYear=yy+1;b11=getLunarMonth11(yy+1,timeZone)}var lunarDay=dayNumber-monthStart+1;var diff=Math.floor((monthStart-a11)/29);var lunarMonth=diff+11;var lunarLeap=0;if(b11-a11>365){var leapMonthDiff=getLeapMonthOffset(a11,timeZone);if(diff>=leapMonthDiff){lunarMonth=diff+10;if(diff===leapMonthDiff)lunarLeap=1}}if(lunarMonth>12)lunarMonth-=12;if(lunarMonth>=11&&diff<4)lunarYear-=1;return{day:lunarDay,month:lunarMonth,year:lunarYear,leap:lunarLeap}}
    function convertLunar2Solar(lunarDay,lunarMonth,lunarYear,lunarLeap,timeZone){try{var a11=getLunarMonth11(lunarYear,timeZone);var b11=getLunarMonth11(lunarYear+1,timeZone);var off=lunarMonth-11;if(off<0)off+=12;var k=Math.floor(0.5+(a11-2415021.076998695)/29.530588853);var monthStart=getNewMoonDay(k+off,timeZone);if(b11-a11>365){var leapOff=getLeapMonthOffset(a11,timeZone);var leapMonth=leapOff-2;if(leapMonth<0)leapMonth+=12;if(lunarLeap!==0&&lunarMonth!==leapMonth)return null;if(lunarLeap!==0||off>=leapOff)monthStart=getNewMoonDay(k+off+1,timeZone)}var jd=monthStart+lunarDay-1;return jdToDate(jd)}catch(e){return null}}

    // MASK INPUTS
    document.querySelectorAll('.date-mask').forEach(i=>i.addEventListener('input',e=>{let v=e.target.value.replace(/\D/g,'').slice(0,8);if(v.length>=5)e.target.value=`${v.slice(0,2)}/${v.slice(2,4)}/${v.slice(4)}`;else if(v.length>=3)e.target.value=`${v.slice(0,2)}/${v.slice(2)}`;else e.target.value=v}));
    document.querySelectorAll('.date-mask-short').forEach(i=>i.addEventListener('input',e=>{let v=e.target.value.replace(/\D/g,'').slice(0,4);if(v.length>=3)e.target.value=`${v.slice(0,2)}/${v.slice(2)}`;else e.target.value=v}));

    // RENDER CALENDAR
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        document.getElementById('calTitle').textContent = `Th√°ng ${viewMonth + 1} / ${viewYear}`;
        grid.innerHTML = '';
        const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
        const startDow = new Date(viewYear, viewMonth, 1).getDay();
        const now = new Date();
        for(let i=0; i<startDow; i++) grid.appendChild(document.createElement('div'));
        for(let d=1; d<=daysInMonth; d++){
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            const lun = convertSolar2Lunar(d, viewMonth+1, viewYear, 7);
            if(now.getDate()===d && now.getMonth()===viewMonth && now.getFullYear()===viewYear) cell.classList.add('today');
            if(selectedDate.getDate()===d && selectedDate.getMonth()===viewMonth && selectedDate.getFullYear()===viewYear) cell.classList.add('active');
            if(notesMap.has(`Y-${pad(d)}-${pad(lun.month)}-${lun.year}`) || notesMap.has(`AN-${pad(d)}-${pad(lun.month)}`)){
                const dot=document.createElement('div'); dot.className='has-note-dot'; cell.appendChild(dot);
            }
            cell.innerHTML += `<div class="solar-num">${d}</div><div class="lunar-info ${lun.day===1||lun.day===15?'special':''}">${lun.day}/${lun.month}${lun.leap?' (N)':''}</div>`;
            cell.onclick = () => { selectedDate = new Date(viewYear, viewMonth, d); renderCalendar(); };
            grid.appendChild(cell);
        }
    }

    // AUTH & LOGIC M·ªöI
    const loginModal = document.getElementById('loginModal');
    window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
    
    document.getElementById('btnAuth').onclick = () => {
        if(currentUser) signOut(auth);
        else loginModal.style.display = 'flex';
    };

    // --- GOOGLE SIGN IN ---
    document.getElementById('btnGoogleLogin').onclick = async () => {
        try {
            await signInWithPopup(auth, googleProvider);
            closeModals();
        } catch (error) {
            alert('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message);
        }
    };

    // NOTE LOGIC
    document.getElementById('btnAddNote').onclick = () => {
        if(!currentUser) { loginModal.style.display='flex'; return; }
        const lun = convertSolar2Lunar(selectedDate.getDate(), selectedDate.getMonth()+1, selectedDate.getFullYear(), 7);
        document.getElementById('popupDay').value = `${pad(lun.day)}/${pad(lun.month)}`;
        document.getElementById('popupYear').value = '';
        document.getElementById('popupAnnual').checked = false;
        document.getElementById('popupText').value = '';
        const idY = `Y-${pad(lun.day)}-${pad(lun.month)}-${lun.year}`, idAn = `AN-${pad(lun.day)}-${pad(lun.month)}`;
        const exist = notesMap.get(idY) || notesMap.get(idAn);
        if(exist){ document.getElementById('popupText').value = exist.text; if(exist.year)document.getElementById('popupYear').value=exist.year; if(exist.annual)document.getElementById('popupAnnual').checked=true; }
        document.getElementById('noteModal').style.display = 'flex';
    };

    document.getElementById('btnSaveNote').onclick = async () => {
        const dStr=document.getElementById('popupDay').value, yStr=document.getElementById('popupYear').value, txt=document.getElementById('popupText').value, ann=document.getElementById('popupAnnual').checked;
        const [d,m] = dStr.split('/');
        if(!d||!m||!txt) return alert('Thi·∫øu ng√†y ho·∫∑c n·ªôi dung');
        let id = `D-${d}-${m}`; if(ann)id=`AN-${d}-${m}`; else if(yStr)id=`Y-${d}-${m}-${yStr}`;
        try{ await setDoc(doc(db,'users',currentUser.uid,'notes',id),{id,text:txt,day:parseInt(d),month:parseInt(m),year:yStr||null,annual:ann,savedAt:new Date().toISOString()}); closeModals(); }catch(e){alert(e.message)}
    };

    document.getElementById('btnViewAllNotes').onclick = () => {
        const c = document.getElementById('notesListContainer'); c.innerHTML='';
        if(!currentUser) return c.innerHTML='<div style="padding:20px;text-align:center">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem.</div>', document.getElementById('listModal').style.display='flex';
        if(notesMap.size===0) c.innerHTML='<div style="padding:20px;text-align:center">Ch∆∞a c√≥ ghi ch√∫ n√†o.</div>';
        notesMap.forEach(n=>{
            const div=document.createElement('div'); div.className='list-item';
            div.innerHTML=`<div><div class="list-date">${pad(n.day)}/${pad(n.month)} √Çm ${n.annual?'(L·∫∑p)':'/ '+n.year}</div><div>${n.text}</div></div><button class="danger btn-icon" onclick="window.delNote('${n.id}')">üóë</button>`;
            c.appendChild(div);
        });
        document.getElementById('listModal').style.display='flex';
    };
    window.delNote = async (id) => { if(confirm('Xo√° nh√©?')) await deleteDoc(doc(db,'users',currentUser.uid,'notes',id)); document.getElementById('listModal').style.display='none'; }
    document.getElementById('btnOpenAddFromList').onclick = () => { if(!currentUser)return loginModal.style.display='flex'; closeModals(); document.getElementById('popupDay').value='';document.getElementById('popupText').value=''; document.getElementById('noteModal').style.display='flex'; }

    // AUTH STATE
    onAuthStateChanged(auth, u => {
        currentUser = u;
        const btn = document.getElementById('btnAuth'), st = document.getElementById('authState');
        if(u){
            st.style.display='inline'; st.textContent = u.displayName || u.email;
            btn.textContent = 'ƒêƒÉng xu·∫•t'; btn.classList.add('danger');
            onSnapshot(collection(db,'users',u.uid,'notes'), s=>{ notesMap.clear(); s.forEach(d=>notesMap.set(d.id,d.data())); renderCalendar(); });
        } else {
            st.style.display='none'; btn.textContent = 'ƒêƒÉng nh·∫≠p'; btn.classList.remove('danger');
            notesMap.clear(); renderCalendar();
        }
    });

    // EVENTS
    document.getElementById('prevMonth').onclick=()=>{viewMonth--;if(viewMonth<0){viewMonth=11;viewYear--}renderCalendar()};
    document.getElementById('nextMonth').onclick=()=>{viewMonth++;if(viewMonth>11){viewMonth=0;viewYear++}renderCalendar()};
    document.getElementById('btnJumpToday').onclick=()=>{const n=new Date();viewMonth=n.getMonth();viewYear=n.getFullYear();selectedDate=n;renderCalendar()};
    document.querySelectorAll('.tab').forEach(t=>t.onclick=function(){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));this.classList.add('active');const tb=this.dataset.tab;document.getElementById('tabS2L').style.display=tb==='s2l'?'block':'none';document.getElementById('tabL2S').style.display=tb==='l2s'?'block':'none'});
    document.getElementById('toLunar').onclick=()=>{const v=document.getElementById('solarInput').value,[d,m,y]=v.split('/').map(Number);if(!d)return;const r=convertSolar2Lunar(d,m,y,7);document.getElementById('s2lResult').textContent=`=> ${pad(r.day)}/${pad(r.month)}/${r.year}${r.leap?' (N)':''} AL`};
    document.getElementById('toSolar').onclick=()=>{const v=document.getElementById('lunarInput').value,[d,m,y]=v.split('/').map(Number);if(!d)return;const r=convertLunar2Solar(d,m,y,document.getElementById('isLeap').checked?1:0,7);document.getElementById('l2sResult').textContent=r?`=> ${pad(r[0])}/${pad(r[1])}/${r[2]} DL`:'Kh√¥ng t·ªìn t·∫°i'};

    renderCalendar();
  </script>
</body>
</html>