<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch √Çm D∆∞∆°ng Chu·∫©n (Tra C·ª©u B·∫£ng)</title>
    <style>
        :root { --primary: #d32f2f; --secondary: #4caf50; --bg: #f4f4f4; --accent: #ff9800; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; gap: 15px; }

        /* Notification */
        #notify-area { display: none; background: #fff3cd; color: #856404; padding: 15px; border-radius: 12px; border-left: 5px solid var(--accent); box-shadow: 0 2px 10px rgba(0,0,0,0.1); animation: slideDown 0.5s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* Search Box */
        .search-box { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid var(--primary); }
        .search-row { display: flex; gap: 8px; margin-bottom: 10px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; flex: 1; outline: none; }
        .btn-tra { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; transition: 0.2s; }
        .btn-tra:active { transform: scale(0.98); }

        /* Display */
        .header-main { background: white; padding: 30px 15px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(211, 47, 47, 0.1); }
        .current-solar { font-size: 3.2rem; font-weight: 800; color: var(--primary); margin: 0; }
        .current-lunar { font-size: 1.2rem; color: #444; margin-top: 15px; font-weight: 600; background: #fff1f1; padding: 12px; border-radius: 12px; border: 1px dashed var(--primary); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; animation: pop 0.2s ease-out; }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .m-label { font-size: 0.9rem; color: #777; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .m-result { font-size: 2rem; font-weight: 800; color: var(--primary); margin-bottom: 5px; line-height: 1.2; }
        .m-weekday { font-size: 1.2rem; color: #333; font-weight: 600; margin-bottom: 25px; display: block; }
        .btn-close { background: #333; color: white; border: none; padding: 12px 0; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; }

        /* Notes */
        .notes-box { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .note-item { background: #f9f9f9; padding: 10px; margin-top: 8px; border-radius: 8px; display: flex; justify-content: space-between; border-left: 4px solid var(--secondary); font-size: 0.95rem; align-items: center; }
        .del { color: #d32f2f; cursor: pointer; font-weight: bold; padding: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div id="notify-area"></div>

    <div class="search-box">
        <div class="search-row">
            <input type="text" id="input-date" placeholder="dd-mm-yyyy" maxlength="10">
            <select id="search-type">
                <option value="s2l">D∆∞∆°ng ‚Üí √Çm</option>
                <option value="l2s">√Çm ‚Üí D∆∞∆°ng</option>
            </select>
        </div>
        <button class="btn-tra" onclick="doSearch()">TRA K·∫æT QU·∫¢</button>
    </div>

    <div class="header-main">
        <div id="today-solar" class="current-solar">--/--/----</div>
        <div id="today-lunar" class="current-lunar">ƒêang t√≠nh...</div>
    </div>

    <div class="notes-box">
        <h4 style="margin:0 0 10px 0">Ghi ch√∫ (Ng√†y √¢m)</h4>
        <input type="text" id="n-date" placeholder="V√≠ d·ª•: 21-12" style="width:100%; margin-bottom:8px; box-sizing: border-box;">
        <input type="text" id="n-txt" placeholder="N·ªôi dung nh·∫Øc nh·ªü" style="width:100%; margin-bottom:10px; box-sizing: border-box;">
        <button class="btn-tra" style="background:var(--secondary)" onclick="saveNote()">L∆ØU GHI CH√ö</button>
        <div id="note-list"></div>
    </div>
</div>

<div id="modal" class="modal-overlay">
    <div class="modal-content">
        <div class="m-label" id="m-title">K·∫æT QU·∫¢</div>
        <div class="m-result" id="m-val">--/--/----</div>
        <span class="m-weekday" id="m-dow">Th·ª©...</span>
        <button class="btn-close" onclick="closeModal()">ƒê√≥ng</button>
    </div>
</div>

<script>
    /* ===================================================================
    B·∫¢NG D·ªÆ LI·ªÜU G·ªêC (M√πng 1 √Çm L·ªãch t∆∞∆°ng ·ª©ng Ng√†y D∆∞∆°ng)
    Ngu·ªìn: L·ªãch V·∫°n Ni√™n 24h & H·ªì Ng·ªçc ƒê·ª©c (ƒê√£ hi·ªáu ch·ªânh ch√≠nh x√°c)
    C·∫•u tr√∫c: { lM: Th√°ng √Çm, lY: NƒÉm √Çm, sD: Ng√†y D∆∞∆°ng, sM: Th√°ng D∆∞∆°ng, sY: NƒÉm D∆∞∆°ng }
    =================================================================== 
    */
    const DB_CALENDAR = [
        {lM: 9, lY: 2025, sD: 21, sM: 10, sY: 2025},
        {lM: 10, lY: 2025, sD: 21, sM: 11, sY: 2025},
        {lM: 11, lY: 2025, sD: 21, sM: 12, sY: 2025}, // M√πng 1 T11 = 21/12
        {lM: 12, lY: 2025, sD: 19, sM: 1, sY: 2026},  // M√πng 1 Ch·∫°p = 19/01 (M·ªëc quan tr·ªçng!)
        {lM: 1, lY: 2026, sD: 17, sM: 2, sY: 2026},   // M√πng 1 T·∫øt = 17/02
        {lM: 2, lY: 2026, sD: 19, sM: 3, sY: 2026},
        {lM: 3, lY: 2026, sD: 17, sM: 4, sY: 2026},
        {lM: 4, lY: 2026, sD: 16, sM: 5, sY: 2026},
        {lM: 5, lY: 2026, sD: 15, sM: 6, sY: 2026},
        {lM: 6, lY: 2026, sD: 14, sM: 7, sY: 2026},
        {lM: 7, lY: 2026, sD: 12, sM: 8, sY: 2026},
        {lM: 8, lY: 2026, sD: 11, sM: 9, sY: 2026},
        {lM: 9, lY: 2026, sD: 10, sM: 10, sY: 2026},
        {lM: 10, lY: 2026, sD: 9, sM: 11, sY: 2026},
        {lM: 11, lY: 2026, sD: 9, sM: 12, sY: 2026},
        {lM: 12, lY: 2026, sD: 8, sM: 1, sY: 2027}
    ];

    // --- H√ÄM 1: D∆Ø∆†NG -> √ÇM (Ch√≠nh x√°c tuy·ªát ƒë·ªëi d·ª±a tr√™n b·∫£ng m·ªëc) ---
    function s2l(d, m, y) {
        // ƒê·∫∑t gi·ªù 12:00 tr∆∞a ƒë·ªÉ tr√°nh l·ªách m√∫i gi·ªù khi tr·ª´ ng√†y
        let target = new Date(y, m - 1, d, 12, 0, 0);
        let match = null;

        // T√¨m m·ªëc M√πng 1 √Çm g·∫ßn nh·∫•t trong qu√° kh·ª©
        for (let i = DB_CALENDAR.length - 1; i >= 0; i--) {
            let item = DB_CALENDAR[i];
            let start = new Date(item.sY, item.sM - 1, item.sD, 12, 0, 0);
            
            if (target >= start) {
                // T√≠nh s·ªë ng√†y ch√™nh l·ªách
                let diffTime = target - start;
                let diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                // Ng√†y √Çm = 1 + s·ªë ng√†y ch√™nh l·ªách
                return [diffDays + 1, item.lM, item.lY];
            }
        }
        // Fallback (ch·ªâ d√πng n·∫øu ngo√†i ph·∫°m vi data 2025-2027)
        return [d, m, y]; 
    }

    // --- H√ÄM 2: √ÇM -> D∆Ø∆†NG (S·ª≠a l·∫°i chu·∫©n ch·ªâ) ---
    function l2s(ld, lm, ly) {
        for (let i = 0; i < DB_CALENDAR.length; i++) {
            let item = DB_CALENDAR[i];
            // T√¨m ƒë√∫ng b·∫£n ghi Th√°ng/NƒÉm √Çm l·ªãch
            if (item.lM === lm && item.lY === ly) {
                let start = new Date(item.sY, item.sM - 1, item.sD, 12, 0, 0);
                
                // C·ªông th√™m (Ng√†y √Çm - 1) ƒë·ªÉ ra ng√†y D∆∞∆°ng
                start.setDate(start.getDate() + (ld - 1));
                
                return [start.getDate(), start.getMonth() + 1, start.getFullYear()];
            }
        }
        return [ld, lm, ly]; // Tr·∫£ v·ªÅ nguy√™n g·ªëc n·∫øu kh√¥ng t√¨m th·∫•y
    }

    function getDayOfWeek(d, m, y) {
        const days = ["Ch·ªß Nh·∫≠t", "Th·ª© Hai", "Th·ª© Ba", "Th·ª© T∆∞", "Th·ª© NƒÉm", "Th·ª© S√°u", "Th·ª© B·∫£y"];
        return days[new Date(y, m - 1, d).getDay()];
    }

    /* FORMAT INPUT T·ª∞ ƒê·ªòNG */
    function setupInputFormatting(elementId) {
        const el = document.getElementById(elementId);
        el.addEventListener('input', (e) => {
            if (e.inputType === 'deleteContentBackward') return;
            let v = e.target.value.replace(/\D/g, '');
            let final = "";
            if (v.length >= 1) {
                let d = v.substring(0, 2);
                if (d.length === 1 && parseInt(d) > 3) d = '0' + d;
                else if (d.length === 2 && parseInt(d) > 31) d = '31';
                final = d;
            }
            if (v.length >= 3) {
                let m = v.substring(2, 4);
                if (m.length === 1 && parseInt(m) > 1) m = '0' + m;
                else if (m.length === 2 && parseInt(m) > 12) m = '12';
                final += '-' + m;
            }
            if (v.length >= 5) final += '-' + v.substring(4, 8);
            e.target.value = final;
        });
    }
    setupInputFormatting('input-date');
    setupInputFormatting('n-date');

    /* KH·ªûI T·∫†O & HI·ªÇN TH·ªä */
    function init() {
        const n = new Date();
        const d = n.getDate(), m = n.getMonth() + 1, y = n.getFullYear();
        document.getElementById('today-solar').innerText = `${d}/${m}/${y}`;
        
        const r = s2l(d, m, y);
        const todayLunarStr = `${r[0].toString().padStart(2,'0')}-${r[1].toString().padStart(2,'0')}`;
        
        document.getElementById('today-lunar').innerText = `√Çm l·ªãch: ${r[0]} th√°ng ${r[1]}, ${r[2]} (${getDayOfWeek(d, m, y)})`;
        
        showNotes();
        checkReminders(todayLunarStr);
    }

    function checkReminders(todayLunar) {
        let ns = JSON.parse(localStorage.getItem('notes') || '[]');
        let notices = [];
        ns.forEach(note => {
            // C·∫Øt l·∫•y dd-mm ƒë·ªÉ so s√°nh
            let noteDateShort = note.d.substring(0, 5); 
            if (noteDateShort === todayLunar) notices.push(note.t);
        });
        if (notices.length > 0) {
            const area = document.getElementById('notify-area');
            area.style.display = 'block';
            area.innerHTML = `<strong>üîî NH·∫ÆC NH·ªû H√îM NAY (${todayLunar}):</strong><br> - ${notices.join('<br> - ')}`;
        }
    }

    function doSearch() {
        const inp = document.getElementById('input-date');
        const val = inp.value;
        const p = val.split('-');
        let d = parseInt(p[0]), m = parseInt(p[1]), y = parseInt(p[2]) || 2026;
        
        // Auto correct input (max day of month)
        let max = new Date(y, m, 0).getDate();
        if (d > max) d = max;
        inp.value = `${d.toString().padStart(2, '0')}-${m.toString().padStart(2, '0')}-${y}`;

        const type = document.getElementById('search-type').value;
        let r, title, weekdayString;

        if (type === 's2l') {
            title = "NG√ÄY √ÇM L·ªäCH L√Ä:";
            r = s2l(d, m, y);
            weekdayString = getDayOfWeek(d, m, y);
        } else {
            title = "NG√ÄY D∆Ø∆†NG L·ªäCH L√Ä:";
            r = l2s(d, m, y);
            weekdayString = getDayOfWeek(r[0], r[1], r[2]);
        }
        
        document.getElementById('m-title').innerText = title;
        document.getElementById('m-val').innerText = `${r[0].toString().padStart(2, '0')}-${r[1].toString().padStart(2, '0')}-${r[2]}`;
        document.getElementById('m-dow').innerText = weekdayString;
        document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    
    function saveNote() {
        const d = document.getElementById('n-date').value, t = document.getElementById('n-txt').value;
        if(!d || !t) return alert("Nh·∫≠p ƒë·ªß ƒëi!");
        let ns = JSON.parse(localStorage.getItem('notes') || '[]');
        ns.push({d, t}); localStorage.setItem('notes', JSON.stringify(ns)); 
        document.getElementById('n-date').value = ''; document.getElementById('n-txt').value = '';
        showNotes();
        
        // Check l·∫°i th√¥ng b√°o sau khi l∆∞u
        const lunarTxt = document.getElementById('today-lunar').innerText.match(/(\d+) th√°ng (\d+)/);
        if(lunarTxt) checkReminders(`${lunarTxt[1].padStart(2,'0')}-${lunarTxt[2].padStart(2,'0')}`);
    }

    function showNotes() {
        let ns = JSON.parse(localStorage.getItem('notes') || '[]');
        document.getElementById('note-list').innerHTML = ns.map((x, i) => `
            <div class="note-item">
                <span><b>${x.d}:</b> ${x.t}</span>
                <span class="del" onclick="delNote(${i})">X√≥a</span>
            </div>
        `).join('');
    }

    function delNote(i) {
        let ns = JSON.parse(localStorage.getItem('notes') || '[]');
        ns.splice(i, 1); localStorage.setItem('notes', JSON.stringify(ns)); showNotes();
        document.getElementById('notify-area').style.display = 'none';
    }

    window.onload = init;
</script>
</body>
</html>