<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>L·ªãch √Çm (CHS)</title>

  <style>
    :root{ --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#64748b; --accent:#2563eb; --border:#e2e8f0; --danger:#ef4444; --success:#10b981; }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:flex;justify-content:center;padding:15px}
    .app{width:100%;max-width:600px;padding-bottom:50px}
    
    /* HEADER */
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px; background: #fff; padding: 10px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    .header-left{display:flex;gap:12px;align-items:center}
    
    .logo-img { width: 50px; height: 50px; object-fit: contain; border-radius: 8px; background: #000; }
    h1{font-size:18px;margin:0;font-weight:800;letter-spacing:-0.5px;color:#1e293b}
    .user-name { font-size:13px; color:var(--accent); font-weight:600; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* BUTTONS */
    button{background:var(--accent);border:none;padding:8px 14px;border-radius:8px;color:#fff;cursor:pointer;font-weight:600;font-size:13px;transition:0.2s;box-shadow:0 2px 4px rgba(37,99,235,0.2)}
    button:active{transform:scale(0.96)}
    .ghost{background:white;border:1px solid var(--border);color:var(--text);box-shadow:none}
    .ghost.active{background:#eff6ff;border-color:var(--accent);color:var(--accent)}
    .danger{background:#fee2e2;color:var(--danger);border:1px solid #fecaca;box-shadow:none}
    .btn-icon{padding:8px 10px;display:flex;align-items:center;justify-content:center}
    
    /* CALENDAR */
    .card{background:var(--card);border-radius:20px;padding:20px;margin-bottom:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);border:1px solid var(--border)}
    .calendar-ctrl{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .calendar-title{font-size:18px;font-weight:700;color:var(--accent)}
    .grid-header{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:10px;text-align:center;font-weight:600;color:var(--muted);font-size:13px}
    .grid-days{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    
    /* DAY CELL */
    .day-cell{background:#fff; border:1px solid var(--border); border-radius:12px; aspect-ratio: 1/1.1; padding:4px; cursor:pointer; display:flex; flex-direction:column; justify-content:space-between; position:relative}
    .day-cell.today{border:2px solid var(--accent);background:#eff6ff}
    .day-cell.active{background:var(--accent);color:white;border-color:var(--accent);box-shadow:0 4px 10px rgba(37,99,235,0.4)}
    .day-cell.active .lunar-info{color:rgba(255,255,255,0.8)}
    
    .has-note-dot{width:6px; height:6px; background:var(--success); border-radius:50%; position:absolute; top:6px; right:6px; box-shadow: 0 0 0 1.5px #fff; z-index: 2;}
    .day-cell.active .has-note-dot { box-shadow: 0 0 0 1.5px var(--accent); background: #fff; }

    .solar-num{font-size:16px;font-weight:700;text-align:center;margin-top:2px}
    .lunar-info{font-size:10px;color:var(--muted);text-align:center;margin-bottom:2px}
    .lunar-info.special{color:#e11d48;font-weight:700}
    
    /* CONVERTER */
    .converter-tabs{display:flex;gap:5px;margin-bottom:15px;background:#f1f5f9;padding:4px;border-radius:12px}
    .tab-btn{flex:1;border:none;background:transparent;color:#64748b;padding:8px;border-radius:8px;font-size:13px;font-weight:600;box-shadow:none}
    .tab-btn.active{background:#fff;color:var(--accent);box-shadow:0 1px 2px rgba(0,0,0,0.1)}

    /* LIST & MODAL */
    .list-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f1f5f9;cursor:pointer}
    .section-header{background:#f1f5f9;color:#64748b;font-weight:700;font-size:12px;padding:8px 10px;border-radius:6px;margin-top:15px;margin-bottom:5px;text-transform:uppercase}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px}
    .modal{background:white;width:100%;max-width:380px;border-radius:20px;padding:24px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);animation:popUp 0.2s cubic-bezier(0.16, 1, 0.3, 1)}
    
    input,textarea{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:10px;font-size:16px;outline:none;background:#f8fafc}
    input:focus{border-color:var(--accent);background:#fff}
    .solar-input{font-weight:700;color:#1e293b;letter-spacing:1px}
    .lunar-preview{background:#f1f5f9;padding:10px;border-radius:8px;font-size:13px;color:#475569;margin-bottom:10px;border:1px dashed #cbd5e1}
    @keyframes popUp{from{transform:scale(0.95);opacity:0}to{transform:scale(1);opacity:1}}
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="header-left">
        <img src="logo.png" alt="Logo" class="logo-img" onerror="this.src='https://placehold.co/50x50/000/FFF?text=CHS'">
        <div>
          <h1>L·ªãch √Çm</h1>
          <div id="headerUserName" class="user-name">Kh√°ch</div>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="btnNoti" class="ghost btn-icon">üîî</button>
        <button id="btnAuth" class="ghost">Login</button>
      </div>
    </header>

    <section class="card" style="padding:15px">
        <div class="calendar-ctrl">
            <button id="prevMonth" class="ghost btn-icon" style="width:40px">&lt;</button>
            <div class="calendar-title" id="calTitle">...</div>
            <button id="nextMonth" class="ghost btn-icon" style="width:40px">&gt;</button>
        </div>
        <div class="grid-header"><div>CN</div><div>T2</div><div>T3</div><div>T4</div><div>T5</div><div>T6</div><div>T7</div></div>
        <div class="grid-days" id="calendarGrid"></div>
        <div style="display:flex;gap:10px;margin-top:16px">
             <button id="btnAddNote" style="flex:1">+ Th√™m</button>
             <button id="btnViewAllNotes" class="ghost" style="flex:1">Danh s√°ch</button>
             <button id="btnJumpToday" class="ghost" style="flex:1">H√¥m nay</button>
        </div>
    </section>

    <section class="card">
        <div class="converter-tabs">
            <button class="tab-btn active" id="tabS2L">D∆∞∆°ng ‚Üí √Çm</button>
            <button class="tab-btn" id="tabL2S">√Çm ‚Üí D∆∞∆°ng</button>
        </div>

        <div id="viewS2L">
            <div style="display:flex;gap:8px">
                <input type="text" id="solarInput" class="date-mask" placeholder="dd/mm/yyyy" inputmode="numeric">
                <button id="btnToLunar" style="width:80px">ƒê·ªïi</button>
            </div>
            <div id="resS2L" style="margin-top:15px;font-weight:700;color:var(--accent);text-align:center;min-height:20px"></div>
        </div>

        <div id="viewL2S" style="display:none">
            <div style="display:flex;gap:8px;margin-bottom:10px">
                <input type="text" id="lunarInput" class="date-mask" placeholder="dd/mm/yyyy (√Çm)" inputmode="numeric">
                <button id="btnToSolar" style="width:80px">ƒê·ªïi</button>
            </div>
            <label style="font-size:14px;display:flex;align-items:center;gap:6px;color:#64748b;margin-bottom:10px">
                <input type="checkbox" id="checkLeap" style="width:auto;margin:0"> Th√°ng nhu·∫≠n
            </label>
            <div id="resL2S" style="margin-top:5px;font-weight:700;color:var(--accent);text-align:center;min-height:20px"></div>
        </div>
    </section>
  </div>

  <div id="loginModal" class="modal-overlay">
    <div class="modal">
        <h3>ƒêƒÉng nh·∫≠p Google</h3>
        <p style="text-align:center;color:#64748b;font-size:13px;margin-bottom:20px">ƒê·ªìng b·ªô ghi ch√∫ tr√™n m·ªçi thi·∫øt b·ªã.</p>
        <button id="btnGoogleLogin" style="width:100%;background:#fff;color:#333;border:1px solid #ddd;display:flex;align-items:center;justify-content:center;gap:10px;padding:12px;font-weight:600">
             <span style="color:red;font-weight:bold">G</span> Ti·∫øp t·ª•c v·ªõi Google
        </button>
        <div style="margin-top:15px;text-align:center;font-size:13px;color:#94a3b8;cursor:pointer" onclick="window.closeModals()">ƒê√≥ng</div>
    </div>
  </div>

  <div id="noteModal" class="modal-overlay">
      <div class="modal">
          <h3>‚úçÔ∏è Ghi ch√∫ m·ªõi</h3>
          <div style="margin-bottom:12px">
              <label style="font-size:12px;font-weight:600;color:#64748b">Ng√†y D∆∞∆°ng (Nh·∫≠p ƒë·ªÉ t·ª± t√≠nh √Çm)</label>
              <input type="text" id="popupSolarDate" class="date-mask solar-input" placeholder="dd/mm/yyyy" inputmode="numeric">
          </div>
          <div class="lunar-preview" id="popupLunarPreview">...</div>
          <div style="display:none"><input type="text" id="popupDay"><input type="number" id="popupYear"></div>

          <label style="display:flex;gap:10px;align-items:center;font-size:14px;padding:10px 0;cursor:pointer">
              <input type="checkbox" id="popupAnnual" style="width:20px;height:20px;margin:0"> 
              L·∫∑p l·∫°i h√†ng nƒÉm (Gi·ªó, SN)
          </label>
          <textarea id="popupText" rows="3" placeholder="N·ªôi dung..."></textarea>
          <div style="display:flex;gap:10px;margin-top:15px">
              <button id="btnSaveNote" style="flex:1">L∆∞u</button>
              <button onclick="window.closeModals()" class="ghost" style="flex:1">Hu·ª∑</button>
          </div>
      </div>
  </div>

  <div id="listModal" class="modal-overlay">
      <div class="modal" style="max-height:85vh;display:flex;flex-direction:column">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
              <h3>Danh s√°ch</h3>
              <button onclick="window.closeModals()" class="ghost" style="padding:4px 10px;border-radius:50%">‚úï</button>
          </div>
          <div style="font-size:12px;color:#64748b;text-align:center;margin-bottom:10px">B·∫•m v√†o s·ª± ki·ªán ƒë·ªÉ xem tr√™n l·ªãch</div>
          <div style="overflow-y:auto;flex:1;padding-right:5px" id="notesListContainer"></div>
          <div style="margin-top:15px"><button id="btnOpenAddFromList" class="ghost" style="width:100%">+ Th√™m th·ªß c√¥ng</button></div>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDtBHNripkXGG__LgW16VO0bKCayxzVarE",
      authDomain: "ghichulich.firebaseapp.com",
      projectId: "ghichulich",
      storageBucket: "ghichulich.firebasestorage.app",
      messagingSenderId: "102308589212",
      appId: "1:102308589212:web:f4ce4981e3a6214eeb0759"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    let currentUser = null;
    let notesMap = new Map();
    let viewMonth = new Date().getMonth(), viewYear = new Date().getFullYear(), selectedDate = new Date(); 

    // HELPERS L·ªäCH
    function pad(n){return n.toString().padStart(2,'0')}
    function jdFromDate(dd,mm,yy){var a=Math.floor((14-mm)/12);var y=yy+4800-a;var m=mm+12*a-3;var jd=dd+Math.floor((153*m+2)/5)+365*y+Math.floor(y/4)-Math.floor(y/100)+Math.floor(y/400)-32045;if(jd<2299161)jd=dd+Math.floor((153*m+2)/5)+365*y+Math.floor(y/4)-32083;return jd}
    function jdToDate(jd){var a,b,c,d,e,m;if(jd>2299160){a=jd+32044;b=Math.floor((4*a+3)/146097);c=a-Math.floor((b*146097)/4)}else{b=0;c=jd+32082}d=Math.floor((4*c+3)/1461);e=c-Math.floor((1461*d)/4);m=Math.floor((5*e+2)/153);var day=e-Math.floor((153*m+2)/5)+1;var month=m+3-12*Math.floor(m/10);var year=b*100+d-4800+Math.floor(m/10);return[day,month,year]}
    function getNewMoonDay(k,timeZone){var T=k/1236.85,T2=T*T,T3=T2*T,dr=Math.PI/180;var Jd1=2415020.75933+29.53058868*k+0.0001178*T2-0.000000155*T3;Jd1+=0.00033*Math.sin((166.56+132.87*T-0.009173*T2)*dr);var M=359.2242+29.10535608*k-0.0000333*T2-0.00000347*T3;var Mpr=306.0253+385.81691806*k+0.0107306*T2+0.00001236*T3;var F=21.2964+390.67050646*k-0.0016528*T2-0.00000239*T3;var C1=(0.1734-0.000393*T)*Math.sin(M*dr)+0.0021*Math.sin(2*dr*M);C1=C1-0.4068*Math.sin(Mpr*dr)+0.0161*Math.sin(2*dr*Mpr)-0.0004*Math.sin(3*dr*Mpr);C1=C1+0.0104*Math.sin(2*dr*F)-0.0051*Math.sin((M+Mpr)*dr)-0.0074*Math.sin((M-Mpr)*dr);C1=C1+0.0004*Math.sin((2*F+M)*dr)-0.0004*Math.sin((2*F-M)*dr)-0.0006*Math.sin((2*F+Mpr)*dr);C1=C1+0.0010*Math.sin((2*F-Mpr)*dr)+0.0005*Math.sin((2*Mpr)*dr);var deltaT;if(T<-11)deltaT=0.001+0.000839*T+0.0002261*T2-0.00000845*T3-0.000000081*T*T3;else deltaT=-0.000278+0.000265*T+0.000262*T2;var JdNew=Jd1+C1-deltaT;return Math.floor(JdNew+0.5+timeZone/24)}
    function getSunLongitude(jdn,timeZone){var T=(jdn-2451545.5-timeZone/24)/36525,T2=T*T,dr=Math.PI/180;var M=357.52910+35999.05030*T-0.0001559*T2-0.00000048*T*T2;var L0=280.46645+36000.76983*T+0.0003032*T2;var DL=(1.914600-0.004817*T-0.000014*T2)*Math.sin(dr*M);DL=DL+(0.019993-0.000101*T)*Math.sin(dr*2*M)+0.000290*Math.sin(dr*3*M);var L=(L0+DL)*dr;L=L-Math.PI*2*(Math.floor(L/(Math.PI*2)));return Math.floor(L/Math.PI*6)}
    function getLunarMonth11(yy,timeZone){var off=jdFromDate(31,12,yy)-2415021;var k=Math.floor(off/29.530588853);var nm=getNewMoonDay(k,timeZone);if(getSunLongitude(nm,timeZone)>=9)nm=getNewMoonDay(k-1,timeZone);return nm}
    function getLeapMonthOffset(a11,timeZone){var k=Math.floor((a11-2415021.076998695)/29.530588853+0.5);var last=0,i=1;var arc=getSunLongitude(getNewMoonDay(k+i,timeZone),timeZone);do{last=arc;i++;arc=getSunLongitude(getNewMoonDay(k+i,timeZone),timeZone)}while(arc!==last&&i<14);return i-1}
    function convertSolar2Lunar(dd,mm,yy,timeZone){var dayNumber=jdFromDate(dd,mm,yy);var k=Math.floor((dayNumber-2415021.076998695)/29.530588853);var monthStart=getNewMoonDay(k+1,timeZone);if(monthStart>dayNumber)monthStart=getNewMoonDay(k,timeZone);var a11=getLunarMonth11(yy,timeZone),b11=a11,lunarYear;if(a11>=monthStart){lunarYear=yy;a11=getLunarMonth11(yy-1,timeZone)}else{lunarYear=yy+1;b11=getLunarMonth11(yy+1,timeZone)}var lunarDay=dayNumber-monthStart+1;var diff=Math.floor((monthStart-a11)/29);var lunarMonth=diff+11;var lunarLeap=0;if(b11-a11>365){var leapMonthDiff=getLeapMonthOffset(a11,timeZone);if(diff>=leapMonthDiff){lunarMonth=diff+10;if(diff===leapMonthDiff)lunarLeap=1}}if(lunarMonth>12)lunarMonth-=12;if(lunarMonth>=11&&diff<4)lunarYear-=1;return{day:lunarDay,month:lunarMonth,year:lunarYear,leap:lunarLeap}}
    function convertLunar2Solar(lunarDay,lunarMonth,lunarYear,lunarLeap,timeZone){try{var a11=getLunarMonth11(lunarYear,timeZone);var b11=getLunarMonth11(lunarYear+1,timeZone);var off=lunarMonth-11;if(off<0)off+=12;var k=Math.floor(0.5+(a11-2415021.076998695)/29.530588853);var monthStart=getNewMoonDay(k+off,timeZone);if(b11-a11>365){var leapOff=getLeapMonthOffset(a11,timeZone);var leapMonth=leapOff-2;if(leapMonth<0)leapMonth+=12;if(lunarLeap!==0&&lunarMonth!==leapMonth)return null;if(lunarLeap!==0||off>=leapOff)monthStart=getNewMoonDay(k+off+1,timeZone)}var jd=monthStart+lunarDay-1;return jdToDate(jd)}catch(e){return null}}

    // Mask Input
    document.querySelectorAll('.date-mask').forEach(i=>i.addEventListener('input',e=>{let v=e.target.value.replace(/\D/g,'').slice(0,8);if(v.length>=5)e.target.value=`${v.slice(0,2)}/${v.slice(2,4)}/${v.slice(4)}`;else if(v.length>=3)e.target.value=`${v.slice(0,2)}/${v.slice(2)}`;else e.target.value=v}));

    // --- TAB TRA C·ª®U ---
    const tabS2L = document.getElementById('tabS2L');
    const tabL2S = document.getElementById('tabL2S');
    const viewS2L = document.getElementById('viewS2L');
    const viewL2S = document.getElementById('viewL2S');

    tabS2L.onclick = () => { tabS2L.classList.add('active'); tabL2S.classList.remove('active'); viewS2L.style.display='block'; viewL2S.style.display='none'; }
    tabL2S.onclick = () => { tabL2S.classList.add('active'); tabS2L.classList.remove('active'); viewL2S.style.display='block'; viewS2L.style.display='none'; }

    // Tra C·ª©u Logic
    document.getElementById('btnToLunar').onclick = () => {
        const v = document.getElementById('solarInput').value;
        const [d,m,y] = v.split('/').map(Number);
        if(!d) return document.getElementById('resS2L').textContent = "Vui l√≤ng nh·∫≠p ng√†y";
        const r = convertSolar2Lunar(d,m,y,7);
        document.getElementById('resS2L').textContent = `√Çm l·ªãch: ${pad(r.day)}/${pad(r.month)}/${r.year} ${r.leap?'(Nhu·∫≠n)':''}`;
    };

    document.getElementById('btnToSolar').onclick = () => {
        const v = document.getElementById('lunarInput').value;
        const [d,m,y] = v.split('/').map(Number);
        const isLeap = document.getElementById('checkLeap').checked;
        if(!d) return document.getElementById('resL2S').textContent = "Vui l√≤ng nh·∫≠p ng√†y";
        const r = convertLunar2Solar(d,m,y,isLeap?1:0,7);
        if(r) document.getElementById('resL2S').textContent = `D∆∞∆°ng l·ªãch: ${pad(r[0])}/${pad(r[1])}/${r[2]}`;
        else document.getElementById('resL2S').textContent = "Ng√†y √¢m n√†y kh√¥ng t·ªìn t·∫°i!";
    };

    // --- LOGIC L·ªäCH ---
    function processNoteData(note) {
        const today = new Date(); today.setHours(0,0,0,0);
        const currentSolarYear = today.getFullYear();
        let nextSolarDate = null;
        if (note.annual) {
            for (let y = currentSolarYear - 1; y <= currentSolarYear + 1; y++) {
                let sol = convertLunar2Solar(note.day, note.month, y, 0, 7);
                if (sol) {
                    let d = new Date(sol[2], sol[1]-1, sol[0]);
                    if (d >= today) { if (!nextSolarDate || d < nextSolarDate) nextSolarDate = d; }
                }
            }
        } else {
            const y = note.year ? parseInt(note.year) : currentSolarYear;
            const sol = convertLunar2Solar(note.day, note.month, y, 0, 7);
            if(sol) nextSolarDate = new Date(sol[2], sol[1]-1, sol[0]);
        }
        let diffTime = Infinity;
        if (nextSolarDate) diffTime = nextSolarDate.getTime() - today.getTime();
        let shouldDelete = false;
        if (!note.annual && nextSolarDate && nextSolarDate.getTime() < today.getTime()) shouldDelete = true;
        return { ...note, nextSolarDate, diffTime, shouldDelete };
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        document.getElementById('calTitle').textContent = `Th√°ng ${viewMonth + 1} / ${viewYear}`;
        grid.innerHTML = '';
        const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
        const startDow = new Date(viewYear, viewMonth, 1).getDay();
        const now = new Date();
        for(let i=0; i<startDow; i++) grid.appendChild(document.createElement('div'));
        for(let d=1; d<=daysInMonth; d++){
            const cell = document.createElement('div'); cell.className = 'day-cell';
            const lun = convertSolar2Lunar(d, viewMonth+1, viewYear, 7);
            if(now.getDate()===d && now.getMonth()===viewMonth && now.getFullYear()===viewYear) cell.classList.add('today');
            if(selectedDate.getDate()===d && selectedDate.getMonth()===viewMonth && selectedDate.getFullYear()===viewYear) cell.classList.add('active');
            
            // CHECK DOT
            const keyAnnual = `AN-${pad(lun.day)}-${pad(lun.month)}`;
            const keySpecific = `Y-${pad(lun.day)}-${pad(lun.month)}-${lun.year}`;
            if(notesMap.has(keyAnnual) || notesMap.has(keySpecific)) {
                const dot = document.createElement('div'); dot.className = 'has-note-dot'; cell.appendChild(dot);
            }

            cell.innerHTML += `<div class="solar-num">${d}</div><div class="lunar-info ${lun.day===1||lun.day===15?'special':''}">${lun.day}/${lun.month}${lun.leap?'(N)':''}</div>`;
            
            // X·ª¨ L√ù CLICK M·ªöI: B·∫§M L√Ä HI·ªÜN POPUP
            cell.onclick = () => { 
                selectedDate = new Date(viewYear, viewMonth, d); 
                renderCalendar();
                document.getElementById('btnAddNote').click();
            };

            grid.appendChild(cell);
        }
    }

    // MODAL
    window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
    const loginModal = document.getElementById('loginModal');
    
    document.getElementById('btnAuth').onclick = () => { if(currentUser) signOut(auth); else loginModal.style.display = 'flex'; };
    document.getElementById('btnGoogleLogin').onclick = async () => { 
        try { await signInWithPopup(auth, googleProvider); window.closeModals(); } catch (e) { alert("L·ªói Login: " + e.message); } 
    };

    // ADD NOTE LOGIC
    document.getElementById('popupSolarDate').addEventListener('input', function() {
        const v = this.value;
        if(v.length === 10) {
            const [d,m,y] = v.split('/').map(Number);
            if(d && m && y) {
                const lun = convertSolar2Lunar(d,m,y,7);
                document.getElementById('popupLunarPreview').textContent = `√Çm: ${pad(lun.day)}/${pad(lun.month)}/${lun.year}`;
                document.getElementById('popupDay').value = `${pad(lun.day)}/${pad(lun.month)}`;
                document.getElementById('popupYear').value = lun.year;
            } else document.getElementById('popupLunarPreview').textContent = "Sai ƒë·ªãnh d·∫°ng";
        }
    });

    document.getElementById('btnAddNote').onclick = () => {
        if(!currentUser) { loginModal.style.display='flex'; return; }
        const sD = selectedDate.getDate(), sM = selectedDate.getMonth()+1, sY = selectedDate.getFullYear();
        document.getElementById('popupSolarDate').value = `${pad(sD)}/${pad(sM)}/${sY}`;
        const lun = convertSolar2Lunar(sD, sM, sY, 7);
        document.getElementById('popupLunarPreview').textContent = `√Çm: ${pad(lun.day)}/${pad(lun.month)}/${lun.year}`;
        document.getElementById('popupDay').value = `${pad(lun.day)}/${pad(lun.month)}`;
        document.getElementById('popupYear').value = lun.year;
        document.getElementById('popupAnnual').checked = false;
        document.getElementById('popupText').value = '';
        
        // Load old note
        const keyAn = `AN-${pad(lun.day)}-${pad(lun.month)}`;
        const keyY = `Y-${pad(lun.day)}-${pad(lun.month)}-${lun.year}`;
        const exist = notesMap.get(keyAn) || notesMap.get(keyY);
        if(exist){
             document.getElementById('popupText').value = exist.text;
             if(exist.annual) document.getElementById('popupAnnual').checked = true;
        }
        document.getElementById('noteModal').style.display = 'flex';
    };

    document.getElementById('btnSaveNote').onclick = async () => {
        const dStr=document.getElementById('popupDay').value, yStr=document.getElementById('popupYear').value, txt=document.getElementById('popupText').value, ann=document.getElementById('popupAnnual').checked;
        const [d,m] = dStr.split('/');
        if(!d||!m||!txt) return alert('Nh·∫≠p n·ªôi dung!');
        const yearVal = yStr ? yStr : new Date().getFullYear();
        const id = ann ? `AN-${pad(d)}-${pad(m)}` : `Y-${pad(d)}-${pad(m)}-${yearVal}`;
        try{ await setDoc(doc(db,'users',currentUser.uid,'notes',id),{id, text:txt, day:parseInt(d), month:parseInt(m), year: yearVal, annual:ann, savedAt:new Date().toISOString()}); window.closeModals(); } catch(e){alert(e.message)}
    };

    // VIEW LIST
    document.getElementById('btnViewAllNotes').onclick = () => {
        const container = document.getElementById('notesListContainer'); container.innerHTML='';
        if(!currentUser) return container.innerHTML='<div style="padding:20px;text-align:center">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem.</div>', document.getElementById('listModal').style.display='flex';
        let normalNotes = [], annualNotes = [];
        notesMap.forEach(note => {
            let n = processNoteData(note);
            if(n.shouldDelete) deleteDoc(doc(db, 'users', currentUser.uid, 'notes', n.id));
            else { if(n.annual) annualNotes.push(n); else normalNotes.push(n); }
        });
        normalNotes.sort((a,b) => a.diffTime - b.diffTime);
        annualNotes.sort((a,b) => a.diffTime - b.diffTime);
        const renderItem = (n) => {
            const div = document.createElement('div'); div.className='list-item';
            div.onclick = (e) => {
                if(e.target.closest('button')) return;
                if(n.nextSolarDate) {
                    viewMonth = n.nextSolarDate.getMonth();
                    viewYear = n.nextSolarDate.getFullYear();
                    selectedDate = new Date(n.nextSolarDate);
                    renderCalendar(); window.closeModals();
                }
            };
            let solarStr = n.nextSolarDate ? `${pad(n.nextSolarDate.getDate())}/${pad(n.nextSolarDate.getMonth()+1)}/${n.nextSolarDate.getFullYear()}` : "L·ªói";
            div.innerHTML=`<div style="flex:1"><div style="display:flex;flex-direction:column"><span style="font-size:15px;font-weight:700;color:var(--accent)">${solarStr}</span><span style="font-size:12px;color:#94a3b8">${pad(n.day)}/${pad(n.month)} √Çm</span></div><div style="margin-top:2px;color:#334155">${n.text}</div></div><button class="danger btn-icon" onclick="window.delNote('${n.id}')">üóë</button>`;
            container.appendChild(div);
        }
        if(normalNotes.length>0) { container.appendChild(Object.assign(document.createElement('div'),{className:'section-header',textContent:'S·∫Øp t·ªõi'})); normalNotes.forEach(renderItem); }
        if(annualNotes.length>0) { container.appendChild(Object.assign(document.createElement('div'),{className:'section-header',textContent:'H√†ng nƒÉm'})); annualNotes.forEach(renderItem); }
        if(normalNotes.length===0 && annualNotes.length===0) container.innerHTML='<div style="padding:20px;text-align:center">Tr·ªëng.</div>';
        document.getElementById('listModal').style.display='flex';
    };

    window.delNote = async (id) => { if(confirm('Xo√°?')) await deleteDoc(doc(db,'users',currentUser.uid,'notes',id)); if(document.getElementById('listModal').style.display === 'flex') document.getElementById('btnViewAllNotes').click(); }

    // NOTI
    document.getElementById('btnNoti').onclick = () => { if(!("Notification" in window)) return alert("Kh√¥ng h·ªó tr·ª£."); Notification.requestPermission().then(p => { if(p==="granted") new Notification("ƒê√£ b·∫≠t th√¥ng b√°o",{icon:"logo.png"}); }); }
    function checkAndNotify(notes) {
        if (!("Notification" in window) || Notification.permission !== "granted") return;
        const tmr = new Date(); tmr.setDate(tmr.getDate() + 1); tmr.setHours(0,0,0,0);
        let msg = [];
        notes.forEach(rawNote => {
            const n = processNoteData(rawNote);
            if (n.nextSolarDate && !n.shouldDelete) {
                const nDate = new Date(n.nextSolarDate); nDate.setHours(0,0,0,0);
                if (nDate.getTime() === tmr.getTime()) msg.push(n.text);
            }
        });
        if (msg.length > 0) new Notification("Mai c√≥ vi·ªác:", { body: msg.join(", "), icon: "logo.png" });
    }

    // INIT
    document.getElementById('btnOpenAddFromList').onclick = () => { if(!currentUser)return loginModal.style.display='flex'; window.closeModals(); document.getElementById('btnAddNote').click(); }
    document.getElementById('prevMonth').onclick=()=>{viewMonth--;if(viewMonth<0){viewMonth=11;viewYear--}renderCalendar()};
    document.getElementById('nextMonth').onclick=()=>{viewMonth++;if(viewMonth>11){viewMonth=0;viewYear++}renderCalendar()};
    document.getElementById('btnJumpToday').onclick=()=>{const n=new Date();viewMonth=n.getMonth();viewYear=n.getFullYear();selectedDate=n;renderCalendar()};

    onAuthStateChanged(auth, u => {
        currentUser = u;
        const btn = document.getElementById('btnAuth');
        const headerName = document.getElementById('headerUserName');
        if(u){
            // HI·ªÇN TH·ªä "ƒê√£ ƒëƒÉng nh·∫≠p" KHI ƒê√É ƒêƒÇNG NH·∫¨P
            btn.textContent = 'ƒê√£ ƒëƒÉng nh·∫≠p'; 
            btn.classList.add('danger');
            headerName.textContent = u.displayName || u.email; 
            
            onSnapshot(collection(db,'users',u.uid,'notes'), s=>{ 
                notesMap.clear(); s.forEach(d=>notesMap.set(d.id,d.data())); 
                renderCalendar(); checkAndNotify(Array.from(notesMap.values()));
            });
        } else {
            // HI·ªÇN TH·ªä "Login" KHI CH∆ØA ƒêƒÇNG NH·∫¨P
            btn.textContent = 'Login'; 
            btn.classList.remove('danger');
            headerName.textContent = 'Kh√°ch';
            
            notesMap.clear(); renderCalendar();
        }
    });
    renderCalendar();
  </script>
</body>
</html>