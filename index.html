<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="L·ªãch √¢m d∆∞∆°ng">
  <link rel="apple-touch-icon" href="ava.png">
  <link rel="manifest" href="manifest.json">

  <title>L·ªãch √Çm D∆∞∆°ng - Tra c·ª©u & Ghi ch√∫ (v3 + Firebase Login)</title>

  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#60a5fa}
    *{box-sizing:border-box}
    body{font-family:Inter, Roboto, system-ui, -apple-system, 'Segoe UI', sans-serif;margin:0;background:linear-gradient(180deg,#081226 0%, #071827 100%);color:#e6eef8;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:20px}
    .app{width:100%;max-width:920px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:12px}
    header h1{font-size:18px;margin:0}
    .card{background:rgba(255,255,255,0.03);border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .row{display:flex;gap:12px;align-items:center}
    .col{display:flex;flex-direction:column;gap:10px}
    .big-date{font-size:26px;font-weight:600}
    .lunar-small{font-size:13px;color:var(--muted)}
    input[type=text], input[type=password], select, textarea{
      background:transparent;border:1px solid rgba(255,255,255,0.08);
      padding:10px;border-radius:8px;color:inherit
    }
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:8px;color:#022;cursor:pointer;font-weight:600}
    .tabs{display:flex;gap:8px}
    .tab{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);cursor:pointer}
    .tab.active{background:linear-gradient(90deg,#2b6be6,#60a5fa);color:#021}
    .note-list{display:flex;flex-direction:column;gap:8px}
    .note-item{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
    .muted{color:var(--muted);font-size:13px}

    /* Auth UI nh·ªè g·ªçn */
    .auth-pill{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .ghost{background:rgba(255,255,255,0.06);color:#e6eef8;border:1px solid rgba(255,255,255,0.08)}
    .danger{background:rgba(244,63,94,0.18);color:#ffd; border:1px solid rgba(244,63,94,0.25)}
    .ok{background:rgba(34,197,94,0.18);color:#eafff1;border:1px solid rgba(34,197,94,0.25)}

    /* Modal */
    .modal-overlay{position:fixed; inset:0; background:rgba(0,0,0,0.65); display:none; align-items:center; justify-content:center; z-index:9999; padding:18px;}
    .modal{width:100%; max-width:420px; background:#0b1220; border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:14px; box-shadow:0 12px 40px rgba(0,0,0,0.45)}
    .modal h3{margin:0 0 10px 0; font-size:16px}
    .modal .muted{margin-bottom:10px}
    .modal input{width:100%}
    .actions{display:flex; gap:8px; margin-top:10px}
    .actions button{flex:1}
    .close{margin-top:10px; width:100%}

    /* Overlay kh√≥a ghi ch√∫ */
    .lock-wrap{position:relative}
    .lock-overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background:rgba(2,6,23,0.62);
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(2px);
      padding:16px;
      text-align:center;
    }
    .lock-overlay .box{
      max-width:420px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      padding:14px;
    }
    .lock-overlay .title{font-weight:700;margin-bottom:6px}
    .lock-overlay .desc{color:var(--muted);font-size:13px;margin-bottom:10px}

    /* Popup th√¥ng b√°o l·ªói (mini modal) */
    .alert-modal{max-width:380px}
    .alert-title{font-weight:800;margin:0 0 6px 0}
    .alert-msg{color:var(--muted);font-size:13px;line-height:1.35;margin:0}

    @media (max-width:720px){
      .row{flex-direction:column;align-items:stretch}
      header{flex-direction:column;align-items:flex-start}
      .big-date{font-size:22px}
      .auth-pill{justify-content:flex-start}
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div>
        <h1>L·ªãch √Çm D∆∞∆°ng ‚Äî Tra c·ª©u & Ghi ch√∫ (v3)</h1>
        <div class="muted">Tra c·ª©u lu√¥n d√πng ƒë∆∞·ª£c ‚Ä¢ Ghi ch√∫ l∆∞u theo t√†i kho·∫£n Firebase</div>
      </div>

      <div class="auth-pill">
        <span id="authState" class="muted">Ch∆∞a ƒëƒÉng nh·∫≠p</span>
        <button id="btnOpenLogin" class="ghost">ƒêƒÉng nh·∫≠p</button>
        <button id="btnLogout" class="danger" style="display:none">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <section class="card" id="todayCard">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="big-date" id="todaySolar"></div>
          <div class="lunar-small" id="todayLunar"></div>
        </div>
        <div class="col" style="align-items:flex-end">
          <div class="muted">V√πng gi·ªù</div>
          <select id="tzSelect"><option value="7">GMT+7 (Vietnam)</option><option value="0">UTC</option></select>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="s2l">D∆∞∆°ng ‚Üí √Çm</div>
        <div class="tab" data-tab="l2s">√Çm ‚Üí D∆∞∆°ng</div>
      </div>

      <div style="margin-top:12px" id="converter">
        <div data-panel="s2l">
          <div class="row" style="gap:10px;align-items:center">
            <input type="text" id="solarInput" placeholder="dd/mm/yyyy (vd: 07/01/2026)" inputmode="numeric" />
            <button id="toLunar">Tra c·ª©u</button>
          </div>
          <div style="margin-top:12px">
            <div class="muted">K·∫øt qu·∫£:</div>
            <div id="s2lResult" style="margin-top:8px"></div>
          </div>
        </div>

        <div data-panel="l2s" style="display:none">
          <div class="row" style="gap:8px;align-items:center">
            <input type="text" id="lunarInput" placeholder="dd/mm/yyyy (√¢m)" inputmode="numeric" />
            <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="isLeap"/>Nhu·∫≠n</label>
            <button id="toSolar">Tra c·ª©u</button>
          </div>
          <div style="margin-top:12px">
            <div class="muted">K·∫øt qu·∫£:</div>
            <div id="l2sResult" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="card lock-wrap" id="notesCard">
      <div id="notesLock" class="lock-overlay">
        <div class="box">
          <div class="title">üîí C·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ d√πng Ghi ch√∫</div>
          <div class="desc">B·∫°n v·∫´n tra c·ª©u l·ªãch b√¨nh th∆∞·ªùng. ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u v√† xem ghi ch√∫ theo t√†i kho·∫£n.</div>
          <button id="btnOpenLogin2" class="ghost">ƒêƒÉng nh·∫≠p</button>
        </div>
      </div>

      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div style="flex:1">
          <div class="muted">Ghi ch√∫ cho ng√†y √¢m (vd 12/12 √¢m ‚Äî ghi l·∫∑p h·∫±ng nƒÉm n·∫øu mu·ªën)</div>

          <div style="margin-top:8px" class="row">
            <input type="text" id="noteLunarDay" placeholder="dd/mm (√¢m)" style="width:150px" inputmode="numeric" />
            <input type="text" id="noteLunarYear" placeholder="(t√πy ch·ªçn yyyy)" style="width:120px" />
            <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="repeatAnnually"/>L·∫∑p h√†ng nƒÉm</label>
          </div>

          <textarea id="noteText" rows="3" placeholder="Vi·∫øt ghi ch√∫..." style="margin-top:8px;width:100%"></textarea>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="saveNote">L∆∞u ghi ch√∫</button>
            <button id="showNotes" class="ghost">Hi·ªán ghi ch√∫ cho ng√†y</button>
          </div>
        </div>

        <div style="width:260px">
          <div class="muted">Ghi ch√∫ cho h√¥m nay (√¢m)</div>
          <div id="todayNotes" style="margin-top:8px"></div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)" />
      <div>
        <div class="muted">T·∫•t c·∫£ ghi ch√∫ ƒë√£ l∆∞u</div>
        <div id="allNotes" class="note-list" style="margin-top:8px"></div>
      </div>
    </section>

    <footer style="margin-top:10px;text-align:center;color:var(--muted)">
      M√£ ngu·ªìn ch·∫°y t·∫°i tr√¨nh duy·ªát ‚Ä¢ D·ªØ li·ªáu ghi ch√∫ l∆∞u Firestore theo t√†i kho·∫£n
    </footer>
  </div>

  <!-- Login modal -->
  <div id="loginOverlay" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>ƒêƒÉng nh·∫≠p</h3>
      <div class="muted">D√πng Email/Password. N·∫øu ch∆∞a c√≥ t√†i kho·∫£n th√¨ b·∫•m ‚ÄúƒêƒÉng k√Ω‚Äù.</div>

      <div class="col">
        <input type="text" id="loginEmail" placeholder="Email" autocomplete="email" />
        <input type="password" id="loginPass" placeholder="M·∫≠t kh·∫©u" autocomplete="current-password" />
      </div>

      <div class="actions">
        <button id="btnLogin">ƒêƒÉng nh·∫≠p</button>
        <button id="btnOpenRegister" class="ghost">ƒêƒÉng k√Ω</button>
      </div>

      <button id="btnCloseLogin" class="close ghost">ƒê√≥ng</button>
    </div>
  </div>

  <!-- Register modal (popup m·ªõi) -->
  <div id="registerOverlay" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>ƒêƒÉng k√Ω</h3>
      <div class="muted">T·∫°o t√†i kho·∫£n m·ªõi b·∫±ng Email/Password.</div>

      <div class="col">
        <input type="text" id="regEmail" placeholder="Email" autocomplete="email" />
        <input type="password" id="regPass" placeholder="M·∫≠t kh·∫©u" autocomplete="new-password" />
        <input type="password" id="regPass2" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" autocomplete="new-password" />
      </div>

      <div class="actions">
        <button id="btnRegister">T·∫°o t√†i kho·∫£n</button>
        <button id="btnBackToLogin" class="ghost">Quay l·∫°i ƒëƒÉng nh·∫≠p</button>
      </div>

      <button id="btnCloseRegister" class="close ghost">ƒê√≥ng</button>
    </div>
  </div>

  <!-- Error popup modal -->
  <div id="alertOverlay" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal alert-modal">
      <h3 class="alert-title" id="alertTitle">Th√¥ng b√°o</h3>
      <p class="alert-msg" id="alertMsg"></p>
      <button id="btnCloseAlert" class="close ghost">ƒê√≥ng</button>
    </div>
  </div>

  <script type="module">
    // ===== Firebase (CDN modular) =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js';
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
    } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';
    import {
      getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot
    } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';

    // ‚úÖ state tr√™n c√πng
    let currentUser = null;
    let unsubNotes = null;
    let notesCache = new Map();

    // TODO: THAY firebaseConfig c·ªßa b·∫°n t·∫°i ƒë√¢y
    const firebaseConfig = {
      apiKey: "AIzaSyDtBHNripkXGG__LgW16VO0bKCayxzVarE",
      authDomain: "ghichulich.firebaseapp.com",
      projectId: "ghichulich",
      storageBucket: "ghichulich.firebasestorage.app",
      messagingSenderId: "102308589212",
      appId: "1:102308589212:web:f4ce4981e3a6214eeb0759",
      measurementId: "G-L7TN785469"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== Popup alert helper =====
    const alertOverlay = document.getElementById('alertOverlay');
    const alertTitleEl = document.getElementById('alertTitle');
    const alertMsgEl = document.getElementById('alertMsg');
    const btnCloseAlert = document.getElementById('btnCloseAlert');

    function showAlert(title, msg){
      alertTitleEl.textContent = title || 'Th√¥ng b√°o';
      alertMsgEl.textContent = msg || '';
      alertOverlay.style.display = 'flex';
    }
    function closeAlert(){ alertOverlay.style.display = 'none'; }
    btnCloseAlert.addEventListener('click', closeAlert);
    alertOverlay.addEventListener('click', (e)=>{ if(e.target === alertOverlay) closeAlert(); });

    function friendlyAuthError(e){
      const code = e?.code || '';
      if(code === 'auth/invalid-credential') return 'Sai email ho·∫∑c m·∫≠t kh·∫©u. Vui l√≤ng ki·ªÉm tra l·∫°i.';
      if(code === 'auth/user-not-found') return 'Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n. B·∫°n c√≥ th·ªÉ b·∫•m ‚ÄúƒêƒÉng k√Ω‚Äù.';
      if(code === 'auth/wrong-password') return 'Sai m·∫≠t kh·∫©u. Vui l√≤ng th·ª≠ l·∫°i.';
      if(code === 'auth/email-already-in-use') return 'Email n√†y ƒë√£ ƒë∆∞·ª£c d√πng. H√£y ƒëƒÉng nh·∫≠p ho·∫∑c d√πng email kh√°c.';
      if(code === 'auth/weak-password') return 'M·∫≠t kh·∫©u qu√° y·∫øu. H√£y d√πng m·∫≠t kh·∫©u d√†i h∆°n (t·ªëi thi·ªÉu 6 k√Ω t·ª±).';
      if(code === 'auth/invalid-email') return 'Email kh√¥ng h·ª£p l·ªá.';
      if(code === 'auth/configuration-not-found') return 'Firebase Auth ch∆∞a c·∫•u h√¨nh ƒë√∫ng (b·∫≠t Email/Password + Authorized domains).';
      return e?.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.';
    }

    // ===== calendar core =====
    function jdFromDate(dd, mm, yy) {
      var a = Math.floor((14 - mm) / 12);
      var y = yy + 4800 - a;
      var m = mm + 12 * a - 3;
      var jd = dd + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4) - Math.floor(y / 100) + Math.floor(y / 400) - 32045;
      if (jd < 2299161) jd = dd + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4) - 32083;
      return jd;
    }
    function jdToDate(jd) {
      var a,b,c,d,e,m;
      if (jd > 2299160) { a = jd + 32044; b = Math.floor((4 * a + 3) / 146097); c = a - Math.floor((b * 146097) / 4); }
      else { b = 0; c = jd + 32082; }
      d = Math.floor((4 * c + 3) / 1461);
      e = c - Math.floor((1461 * d) / 4);
      m = Math.floor((5 * e + 2) / 153);
      var day = e - Math.floor((153 * m + 2) / 5) + 1;
      var month = m + 3 - 12 * Math.floor(m / 10);
      var year = b * 100 + d - 4800 + Math.floor(m / 10);
      return [day, month, year];
    }
    function getNewMoonDay(k, timeZone) {
      var T = k / 1236.85, T2 = T*T, T3 = T2*T, dr = Math.PI/180;
      var Jd1 = 2415020.75933 + 29.53058868*k + 0.0001178*T2 - 0.000000155*T3;
      Jd1 += 0.00033*Math.sin((166.56 + 132.87*T - 0.009173*T2)*dr);
      var M = 359.2242 + 29.10535608*k - 0.0000333*T2 - 0.00000347*T3;
      var Mpr = 306.0253 + 385.81691806*k + 0.0107306*T2 + 0.00001236*T3;
      var F = 21.2964 + 390.67050646*k - 0.0016528*T2 - 0.00000239*T3;
      var C1 = (0.1734 - 0.000393*T)*Math.sin(M*dr) + 0.0021*Math.sin(2*dr*M);
      C1 = C1 - 0.4068*Math.sin(Mpr*dr) + 0.0161*Math.sin(2*dr*Mpr) - 0.0004*Math.sin(3*dr*Mpr);
      C1 = C1 + 0.0104*Math.sin(2*dr*F) - 0.0051*Math.sin((M+Mpr)*dr) - 0.0074*Math.sin((M-Mpr)*dr);
      C1 = C1 + 0.0004*Math.sin((2*F+M)*dr) - 0.0004*Math.sin((2*F-M)*dr) - 0.0006*Math.sin((2*F+Mpr)*dr);
      C1 = C1 + 0.0010*Math.sin((2*F-Mpr)*dr) + 0.0005*Math.sin((2*Mpr)*dr);
      var deltaT;
      if (T < -11) deltaT = 0.001 + 0.000839*T + 0.0002261*T2 - 0.00000845*T3 - 0.000000081*T*T3;
      else deltaT = -0.000278 + 0.000265*T + 0.000262*T2;
      var JdNew = Jd1 + C1 - deltaT;
      return Math.floor(JdNew + 0.5 + timeZone/24);
    }
    function getSunLongitude(jdn, timeZone) {
      var T = (jdn - 2451545.5 - timeZone/24) / 36525, T2 = T*T, dr = Math.PI/180;
      var M = 357.52910 + 35999.05030*T - 0.0001559*T2 - 0.00000048*T*T2;
      var L0 = 280.46645 + 36000.76983*T + 0.0003032*T2;
      var DL = (1.914600 - 0.004817*T - 0.000014*T2)*Math.sin(dr*M);
      DL = DL + (0.019993 - 0.000101*T)*Math.sin(dr*2*M) + 0.000290*Math.sin(dr*3*M);
      var L = (L0 + DL) * dr;
      L = L - Math.PI*2*(Math.floor(L/(Math.PI*2)));
      return Math.floor(L/Math.PI*6);
    }
    function getLunarMonth11(yy, timeZone) {
      var off = jdFromDate(31,12,yy) - 2415021;
      var k = Math.floor(off/29.530588853);
      var nm = getNewMoonDay(k, timeZone);
      if (getSunLongitude(nm, timeZone) >= 9) nm = getNewMoonDay(k-1, timeZone);
      return nm;
    }
    function getLeapMonthOffset(a11, timeZone) {
      var k = Math.floor((a11 - 2415021.076998695)/29.530588853 + 0.5);
      var last = 0, i = 1;
      var arc = getSunLongitude(getNewMoonDay(k+i, timeZone), timeZone);
      do { last = arc; i++; arc = getSunLongitude(getNewMoonDay(k+i, timeZone), timeZone); }
      while (arc !== last && i < 14);
      return i - 1;
    }
    function convertSolar2Lunar(dd, mm, yy, timeZone) {
      var dayNumber = jdFromDate(dd, mm, yy);
      var k = Math.floor((dayNumber - 2415021.076998695) / 29.530588853);
      var monthStart = getNewMoonDay(k+1, timeZone);
      if (monthStart > dayNumber) monthStart = getNewMoonDay(k, timeZone);

      var a11 = getLunarMonth11(yy, timeZone), b11 = a11, lunarYear;
      if (a11 >= monthStart) { lunarYear = yy; a11 = getLunarMonth11(yy-1, timeZone); }
      else { lunarYear = yy+1; b11 = getLunarMonth11(yy+1, timeZone); }

      var lunarDay = dayNumber - monthStart + 1;
      var diff = Math.floor((monthStart - a11) / 29);
      var lunarMonth = diff + 11;
      var lunarLeap = 0;

      if (b11 - a11 > 365) {
        var leapMonthDiff = getLeapMonthOffset(a11, timeZone);
        if (diff >= leapMonthDiff) {
          lunarMonth = diff + 10;
          if (diff === leapMonthDiff) lunarLeap = 1;
        }
      }
      if (lunarMonth > 12) lunarMonth -= 12;
      if (lunarMonth >= 11 && diff < 4) lunarYear -= 1;
      return {day:lunarDay, month:lunarMonth, year:lunarYear, leap:lunarLeap};
    }
    function convertLunar2Solar(lunarDay, lunarMonth, lunarYear, lunarLeap, timeZone) {
      try {
        var a11 = getLunarMonth11(lunarYear, timeZone);
        var b11 = getLunarMonth11(lunarYear+1, timeZone);
        var off = lunarMonth - 11; if (off < 0) off += 12;
        var k = Math.floor(0.5 + (a11 - 2415021.076998695)/29.530588853);
        var monthStart = getNewMoonDay(k + off, timeZone);

        if (b11 - a11 > 365) {
          var leapOff = getLeapMonthOffset(a11, timeZone);
          var leapMonth = leapOff - 2; if (leapMonth < 0) leapMonth += 12;
          if (lunarLeap !== 0 && lunarMonth !== leapMonth) return null;
          if (lunarLeap !== 0 || off >= leapOff) monthStart = getNewMoonDay(k + off + 1, timeZone);
        }
        var jd = monthStart + lunarDay - 1;
        return jdToDate(jd);
      } catch(e) { return null; }
    }

    function pad(n){return n.toString().padStart(2,'0')}
    function fmtSolar(d,m,y){return pad(d) + '-' + pad(m) + '-' + y}
    function fmtLunar(obj){ if(!obj) return ''+obj; return pad(obj.day)+'-'+pad(obj.month)+(obj.leap? ' (nhu·∫≠n)':'') + ' - ' + obj.year; }
    function weekdayFromDate(d,m,y){
      const dt = new Date(y, m-1, d);
      const days = ['Ch·ªß nh·∫≠t','Th·ª© 2','Th·ª© 3','Th·ª© 4','Th·ª© 5','Th·ª© 6','Th·ª© 7'];
      return days[dt.getDay()];
    }

    // ===== UI wiring =====
    const todaySolarEl = document.getElementById('todaySolar');
    const todayLunarEl = document.getElementById('todayLunar');
    const tzSelect = document.getElementById('tzSelect');
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('[data-panel]');

    function updateToday() {
      const now = new Date();
      const d = now.getDate(), m = now.getMonth()+1, y = now.getFullYear();
      todaySolarEl.textContent = fmtSolar(d,m,y) + ' ‚Ä¢ ' + weekdayFromDate(d,m,y);
      const tz = Number(tzSelect.value);
      const lun = convertSolar2Lunar(d,m,y,tz);
      todayLunarEl.textContent = fmtLunar(lun);
      renderTodayNotes(lun);
    }
    tzSelect.addEventListener('change', updateToday);

    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.getAttribute('data-tab');
      panels.forEach(p => p.style.display = p.getAttribute('data-panel') === tab ? '' : 'none');
    }));

    function attachSlashInput(el, maxDigits=8){
      el.addEventListener('input', function () {
        const digits = this.value.replace(/\D/g, '').slice(0,maxDigits);
        let res = '';
        if (digits.length <= 2) res = digits;
        else if (digits.length <= 4) res = digits.slice(0,2) + '/' + digits.slice(2);
        else res = digits.slice(0,2) + '/' + digits.slice(2,4) + '/' + digits.slice(4,8);
        this.value = res;
      });
      el.addEventListener('blur', function () {
        const parts = this.value.split('/');
        if (parts[0]) parts[0] = parts[0].padStart(2,'0');
        if (parts[1]) parts[1] = parts[1].padStart(2,'0');
        if (parts[2]) parts[2] = parts[2].slice(0,4);
        this.value = parts.filter(Boolean).join('/');
      });
    }
    attachSlashInput(document.getElementById('solarInput'), 8);
    attachSlashInput(document.getElementById('lunarInput'), 8);

    const noteLunarDayInput = document.getElementById('noteLunarDay');
    noteLunarDayInput.addEventListener('input', function () {
      const digits = this.value.replace(/\D/g,'').slice(0,4);
      let res = '';
      if (digits.length <= 2) res = digits;
      else res = digits.slice(0,2) + '/' + digits.slice(2);
      this.value = res;
    });
    noteLunarDayInput.addEventListener('blur', function () {
      const parts = this.value.split('/');
      if (parts[0]) parts[0] = parts[0].padStart(2,'0');
      if (parts[1]) parts[1] = parts[1].padStart(2,'0');
      this.value = parts.filter(Boolean).join('/');
    });

    document.getElementById('toLunar').addEventListener('click', ()=>{
      const v = document.getElementById('solarInput').value.trim();
      if(!v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/)) { showAlert('Sai ƒë·ªãnh d·∫°ng', 'Nh·∫≠p theo d·∫°ng dd/mm/yyyy'); return; }
      const [dd,mm,yy] = v.split('/').map(Number);
      const tz = Number(tzSelect.value);
      const res = convertSolar2Lunar(dd,mm,yy,tz);
      document.getElementById('s2lResult').textContent = fmtLunar(res) + ' ‚Ä¢ ' + weekdayFromDate(dd,mm,yy);
    });

    document.getElementById('toSolar').addEventListener('click', ()=>{
      const v = document.getElementById('lunarInput').value.trim();
      if(!v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/)) { showAlert('Sai ƒë·ªãnh d·∫°ng', 'Nh·∫≠p theo d·∫°ng dd/mm/yyyy (√¢m)'); return; }
      const [dd,mm,yy] = v.split('/').map(Number);
      const leap = document.getElementById('isLeap').checked ? 1:0;
      const tz = Number(tzSelect.value);
      const res = convertLunar2Solar(dd,mm,yy,leap,tz);
      if(!res){ document.getElementById('l2sResult').textContent = 'Kh√¥ng h·ª£p l·ªá (ki·ªÉm tra th√°ng nhu·∫≠n)'; return; }
      document.getElementById('l2sResult').textContent = fmtSolar(res[0],res[1],res[2]) + ' ‚Ä¢ ' + weekdayFromDate(res[0],res[1],res[2]);
    });

    // ===== Notes (Firestore theo user) =====
    function noteIdFromInput(dd, mm, year, annual){
      if (annual) return `AN-${pad(dd)}-${pad(mm)}`;
      if (year) return `Y-${pad(dd)}-${pad(mm)}-${String(year).slice(0,4)}`;
      return `D-${pad(dd)}-${pad(mm)}`;
    }
    function parseNoteDayMonth(str){
      const m = str.match(/^(\d{1,2})\/(\d{1,2})$/);
      if(!m) return null;
      const dd = Number(m[1]), mm = Number(m[2]);
      if(dd < 1 || dd > 31 || mm < 1 || mm > 12) return null;
      return {dd, mm};
    }
    function loadNoteFor(lunDay, lunMonth, lunYear){
      const idY  = noteIdFromInput(lunDay, lunMonth, lunYear, false);
      const idD  = noteIdFromInput(lunDay, lunMonth, null, false);
      const idAN = noteIdFromInput(lunDay, lunMonth, null, true);
      return notesCache.get(idY) || notesCache.get(idD) || notesCache.get(idAN) || null;
    }

    async function saveNoteToFirestore(){
      if(!currentUser){ showAlert('Ch∆∞a ƒëƒÉng nh·∫≠p', 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u ghi ch√∫.'); return; }

      const dmm = document.getElementById('noteLunarDay').value.trim();
      const year = document.getElementById('noteLunarYear').value.trim();
      const annual = document.getElementById('repeatAnnually').checked;
      const txt = document.getElementById('noteText').value.trim();

      const parsed = parseNoteDayMonth(dmm);
      if(!parsed){ showAlert('Sai ƒë·ªãnh d·∫°ng', 'Nh·∫≠p d·∫°ng dd/mm (√¢m)'); return; }
      if(!txt){ showAlert('Thi·∫øu n·ªôi dung', 'Nh·∫≠p n·ªôi dung ghi ch√∫'); return; }

      const noteId = noteIdFromInput(parsed.dd, parsed.mm, year || null, annual);
      const ref = doc(db, 'users', currentUser.uid, 'notes', noteId);

      const payload = {
        id: noteId,
        text: txt,
        day: parsed.dd,
        month: parsed.mm,
        year: year ? String(year).slice(0,4) : null,
        annual: !!annual,
        savedAt: new Date().toISOString()
      };

      await setDoc(ref, payload, { merge: true });
      showAlert('Th√†nh c√¥ng', 'ƒê√£ l∆∞u ghi ch√∫.');
      document.getElementById('noteText').value = '';
    }

    async function deleteNoteFromFirestore(noteId){
      if(!currentUser) return;
      if(!confirm('Xo√° ghi ch√∫?')) return;
      await deleteDoc(doc(db, 'users', currentUser.uid, 'notes', noteId));
    }

    function renderTodayNotes(lun){
      const container = document.getElementById('todayNotes');
      container.innerHTML = '';
      if(!currentUser){
        container.textContent = 'üîí ƒêƒÉng nh·∫≠p ƒë·ªÉ xem ghi ch√∫ c·ªßa b·∫°n';
        return;
      }
      const note = loadNoteFor(lun.day, lun.month, lun.year);
      if(note){
        const div = document.createElement('div');
        div.className='note-item';
        div.textContent = note.text + ' (' + (note.annual? 'L·∫∑p h√†ng nƒÉm' : (note.year? 'Theo nƒÉm ' + note.year : 'Kh√¥ng theo nƒÉm')) + ')';
        container.appendChild(div);
      } else {
        container.textContent = 'Ch∆∞a c√≥ ghi ch√∫ cho h√¥m nay (√¢m)';
      }
    }

    function renderAllNotes(){
      const out = document.getElementById('allNotes');
      out.innerHTML = '';

      if(!currentUser){
        out.innerHTML = '<div class="muted">üîí ƒêƒÉng nh·∫≠p ƒë·ªÉ d√πng ghi ch√∫</div>';
        return;
      }

      const arr = Array.from(notesCache.values()).sort((a,b)=>{
        const ka = `${pad(a.month)}${pad(a.day)}${a.year||'9999'}${a.annual?'1':'0'}`;
        const kb = `${pad(b.month)}${pad(b.day)}${b.year||'9999'}${b.annual?'1':'0'}`;
        return ka.localeCompare(kb);
      });

      arr.forEach(p=>{
        const div = document.createElement('div');
        div.className='note-item';
        const title = `${pad(p.day)}-${pad(p.month)}${p.year? '-' + p.year : ''}${p.annual? ' (L·∫∑p)':''}`;
        div.innerHTML = `
          <strong>${title}</strong>
          <div style="margin-top:6px">${p.text}</div>
          <div class="muted" style="margin-top:6px;font-size:12px">L∆∞u: ${new Date(p.savedAt).toLocaleString()}</div>
          <div style="margin-top:8px"><button class="danger" data-id="${p.id}">Xo√°</button></div>
        `;
        out.appendChild(div);
      });

      out.querySelectorAll('button[data-id]').forEach(b=>{
        b.addEventListener('click', e=>{
          deleteNoteFromFirestore(e.currentTarget.getAttribute('data-id'));
        });
      });
    }

    function setNotesLocked(locked){
      const overlay = document.getElementById('notesLock');
      overlay.style.display = locked ? 'flex' : 'none';

      ['noteLunarDay','noteLunarYear','noteText','repeatAnnually','saveNote','showNotes'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.disabled = !!locked;
      });

      renderAllNotes();
      updateToday();
    }

    document.getElementById('saveNote').addEventListener('click', saveNoteToFirestore);
    document.getElementById('showNotes').addEventListener('click', ()=>{
      if(!currentUser){ showAlert('Ch∆∞a ƒëƒÉng nh·∫≠p', 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem ghi ch√∫.'); return; }

      const dmm = document.getElementById('noteLunarDay').value.trim();
      const year = document.getElementById('noteLunarYear').value.trim();
      const parsed = parseNoteDayMonth(dmm);
      if(!parsed){ showAlert('Sai ƒë·ªãnh d·∫°ng', 'Nh·∫≠p d·∫°ng dd/mm (√¢m)'); return; }

      const y = year ? String(year).slice(0,4) : null;
      const note = y
        ? (notesCache.get(noteIdFromInput(parsed.dd, parsed.mm, y, false)) ||
           notesCache.get(noteIdFromInput(parsed.dd, parsed.mm, null, false)) ||
           notesCache.get(noteIdFromInput(parsed.dd, parsed.mm, null, true)))
        : (notesCache.get(noteIdFromInput(parsed.dd, parsed.mm, null, false)) ||
           notesCache.get(noteIdFromInput(parsed.dd, parsed.mm, null, true)));

      if(note) showAlert('Ghi ch√∫', note.text);
      else showAlert('Ch∆∞a c√≥', 'Ch∆∞a c√≥ ghi ch√∫ cho ng√†y ƒë√≥.');
    });

    // ===== Auth UI (t√°ch login/register) =====
    const loginOverlay = document.getElementById('loginOverlay');
    const registerOverlay = document.getElementById('registerOverlay');

    const btnOpenLogin = document.getElementById('btnOpenLogin');
    const btnOpenLogin2 = document.getElementById('btnOpenLogin2');
    const btnCloseLogin = document.getElementById('btnCloseLogin');
    const btnLogin = document.getElementById('btnLogin');
    const btnOpenRegister = document.getElementById('btnOpenRegister');

    const btnCloseRegister = document.getElementById('btnCloseRegister');
    const btnRegister = document.getElementById('btnRegister');
    const btnBackToLogin = document.getElementById('btnBackToLogin');

    const btnLogout = document.getElementById('btnLogout');
    const authState = document.getElementById('authState');

    function openLogin(){
      loginOverlay.style.display = 'flex';
      // clear fields
      // (kh√¥ng b·∫Øt bu·ªôc, nh∆∞ng cho s·∫°ch)
    }
    function closeLogin(){ loginOverlay.style.display = 'none'; }

    function openRegister(){
      registerOverlay.style.display = 'flex';
    }
    function closeRegister(){ registerOverlay.style.display = 'none'; }

    btnOpenLogin.addEventListener('click', openLogin);
    btnOpenLogin2.addEventListener('click', openLogin);
    btnCloseLogin.addEventListener('click', closeLogin);
    btnOpenRegister.addEventListener('click', ()=>{
      closeLogin();
      openRegister();
    });

    btnBackToLogin.addEventListener('click', ()=>{
      closeRegister();
      openLogin();
    });

    btnCloseRegister.addEventListener('click', closeRegister);

    loginOverlay.addEventListener('click', (e)=>{ if(e.target === loginOverlay) closeLogin(); });
    registerOverlay.addEventListener('click', (e)=>{ if(e.target === registerOverlay) closeRegister(); });

    btnLogin.addEventListener('click', async ()=>{
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value.trim();
      if(!email || !pass){ showAlert('Thi·∫øu th√¥ng tin', 'Nh·∫≠p email v√† m·∫≠t kh·∫©u.'); return; }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        closeLogin();
      }catch(e){
        showAlert('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i', friendlyAuthError(e));
      }
    });

    btnRegister.addEventListener('click', async ()=>{
      const email = document.getElementById('regEmail').value.trim();
      const pass = document.getElementById('regPass').value.trim();
      const pass2 = document.getElementById('regPass2').value.trim();

      if(!email || !pass || !pass2){ showAlert('Thi·∫øu th√¥ng tin', 'Nh·∫≠p ƒë·ªß email v√† m·∫≠t kh·∫©u.'); return; }
      if(pass.length < 6){ showAlert('M·∫≠t kh·∫©u y·∫øu', 'M·∫≠t kh·∫©u t·ªëi thi·ªÉu 6 k√Ω t·ª±.'); return; }
      if(pass !== pass2){ showAlert('Kh√¥ng kh·ªõp', 'M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp.'); return; }

      try{
        await createUserWithEmailAndPassword(auth, email, pass);
        closeRegister();
        // m·ªü login ho·∫∑c kh√¥ng c·∫ßn v√¨ auth ƒë√£ auto login
        showAlert('Th√†nh c√¥ng', 'ƒê√£ t·∫°o t√†i kho·∫£n v√† ƒëƒÉng nh·∫≠p.');
      }catch(e){
        showAlert('ƒêƒÉng k√Ω th·∫•t b·∫°i', friendlyAuthError(e));
      }
    });

    btnLogout.addEventListener('click', async ()=>{
      await signOut(auth);
    });

    function subscribeUserNotes(uid){
      if(unsubNotes) unsubNotes();
      notesCache.clear();

      const notesCol = collection(db, 'users', uid, 'notes');
      unsubNotes = onSnapshot(notesCol, (snap)=>{
        notesCache.clear();
        snap.forEach(docu=> notesCache.set(docu.id, docu.data()));
        renderAllNotes();
        updateToday();
      });
    }

    onAuthStateChanged(auth, (user)=>{
      currentUser = user || null;

      if(currentUser){
        authState.textContent = `ƒê√£ ƒëƒÉng nh·∫≠p: ${currentUser.email || currentUser.uid}`;
        authState.className = 'muted ok';
        btnOpenLogin.style.display = 'none';
        btnLogout.style.display = '';
        setNotesLocked(false);
        subscribeUserNotes(currentUser.uid);
      }else{
        authState.textContent = 'Ch∆∞a ƒëƒÉng nh·∫≠p';
        authState.className = 'muted';
        btnOpenLogin.style.display = '';
        btnLogout.style.display = 'none';

        if(unsubNotes) unsubNotes();
        unsubNotes = null;
        notesCache.clear();

        setNotesLocked(true);
      }
    });

    // init
    setNotesLocked(true);
    updateToday();
  </script>
</body>
</html>
